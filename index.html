<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SI UJANG PRO (Aplikasi Ujian Jujur Anti Curang)</title>
    
    <script>
        function setupTailwind() {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = {
                    theme: {
                        extend: {
                            colors: {
                                primary: '#4f46e5',
                                secondary: '#10b981',
                                accent: '#f59e0b',
                                danger: '#ef4444'
                            },
                            animation: {
                                'fade-in': 'fadeIn 0.5s ease-out',
                            },
                            keyframes: {
                                fadeIn: {
                                    '0%': { opacity: '0', transform: 'translateY(10px)' },
                                    '100%': { opacity: '1', transform: 'translateY(0)' },
                                }
                            }
                        }
                    }
                };
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com" onload="setupTailwind()"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }

        /* --- FITUR KEAMANAN CSS (LEVEL 1) --- */
        
        /* 1. Matikan Seleksi Teks (Anti-Copas) - Default */
        body, #root {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        /* PENGECUALIAN: Admin Mode (Boleh Select/Copas) */
        body.admin-mode, body.admin-mode #root {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }

        /* 2. Anti-Print */
        @media print {
            body { display: none !important; background: black !important; }
            html::after {
                content: "DOKUMEN RAHASIA - DILARANG MENCETAK";
                display: flex; justify-content: center; align-items: center;
                height: 100vh; color: white; background: black;
                font-size: 24pt; font-weight: bold; position: fixed;
                top: 0; left: 0; right: 0; bottom: 0; z-index: 9999;
            }
        }
        
        /* 3. Efek Blur saat Kehilangan Fokus */
        body.security-blur #root {
            filter: blur(15px) grayscale(100%);
            pointer-events: none; opacity: 0.2; transition: all 0.2s;
        }

        body.security-blur::after {
            content: "⚠️ DILARANG PINDAH TAB / SCREENSHOT! ⚠️\A Kembali ke aplikasi untuk melanjutkan.";
            white-space: pre; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: #ef4444; background: white;
            padding: 30px; border: 4px solid #ef4444; border-radius: 20px;
            font-size: 1.5rem; font-weight: 900; text-align: center;
            z-index: 10000; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* Pengecualian agar input form tetap bisa diketik */
        input, textarea {
            -webkit-user-select: text !important;
            user-select: text !important;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, updateDoc, arrayUnion, collection, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const { useState, useEffect, useRef, useMemo } = React;

        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCZfHHvBRK82BgJrViTFrA9oYj9vdoXvIA",
          authDomain: "krenova-27806.firebaseapp.com",
          projectId: "krenova-27806",
          storageBucket: "krenova-27806.firebasestorage.app",
          messagingSenderId: "189901290355",
          appId: "1:189901290355:web:083a0d6ead80dfc3b82306"
        };
        
        const appId = 'exam-system-v1';
        
        let app, auth, db;
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "AIzaSyDVqKOhp7u8WZEwTaMWlqLE3bnzAueQ6iU") {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                console.log("Firebase berhasil diinisialisasi!");
            } else {
                console.warn("Firebase Config belum diisi. Mode Offline.");
            }
        } catch(e) { console.error("Firebase Init Error", e); }

        // --- GLOBAL SECURITY HOOK ---
        const useGlobalSecurity = ({ protectDevTools = true, protectCopyPaste = true, protectContextMenu = true, protectFocus = false }) => {
            useEffect(() => {
                if (!protectFocus) {
                    document.body.classList.remove('security-blur');
                    if (document.title === "⚠️ PERINGATAN! KEMBALI!") {
                        document.title = "SI UJANG PRO (Aplikasi Ujian Jujur Anti Curang)";
                    }
                }

                const handleContextMenu = (e) => {
                    if (protectContextMenu) { e.preventDefault(); return false; }
                };

                const handleKeyDown = (e) => {
                    if (protectDevTools) {
                        if (e.key === 'F12' || e.keyCode === 123) { e.preventDefault(); return false; }
                        if (e.ctrlKey && e.shiftKey && ['I','i','J','j','C','c'].includes(e.key)) { e.preventDefault(); return false; }
                        if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) { e.preventDefault(); return false; }
                    }
                    if (protectCopyPaste) {
                        if (e.ctrlKey && (e.key === 's' || e.key === 'S' || e.key === 'p' || e.key === 'P')) { e.preventDefault(); return false; }
                        if (e.ctrlKey && ['c','C','v','V','x','X'].includes(e.key)) { e.preventDefault(); return false; }
                    }
                };

                const handleKeyUp = (e) => {
                    if (!protectCopyPaste) return;
                    if (e.key === 'PrintScreen' || e.keyCode === 44) {
                        try { 
                            const tempInput = document.createElement("input");
                            tempInput.value = " "; document.body.appendChild(tempInput);
                            tempInput.select(); document.execCommand("copy");
                            document.body.removeChild(tempInput);
                        } catch(err){}
                        alert("PERINGATAN KEAMANAN: Dilarang mengambil tangkapan layar (Screenshot)!");
                        document.body.style.visibility = 'hidden';
                        setTimeout(() => { document.body.style.visibility = 'visible'; }, 1000);
                    }
                };

                const handleBlur = () => {
                    if (protectFocus) {
                        document.body.classList.add('security-blur');
                        document.title = "⚠️ PERINGATAN! KEMBALI!";
                    }
                };
                const handleFocus = () => {
                    if (protectFocus) {
                        document.body.classList.remove('security-blur');
                        document.title = "SI UJANG PRO (Aplikasi Ujian Jujur Anti Curang)";
                    }
                };

                const preventDefault = (e) => { if (protectCopyPaste) e.preventDefault(); };

                document.addEventListener('contextmenu', handleContextMenu);
                window.addEventListener('keydown', handleKeyDown);
                window.addEventListener('keyup', handleKeyUp);
                window.addEventListener('blur', handleBlur);
                window.addEventListener('focus', handleFocus);
                document.addEventListener('copy', preventDefault);
                document.addEventListener('cut', preventDefault);
                document.addEventListener('paste', preventDefault);

                return () => {
                    document.removeEventListener('contextmenu', handleContextMenu);
                    window.removeEventListener('keydown', handleKeyDown);
                    window.removeEventListener('keyup', handleKeyUp);
                    window.removeEventListener('blur', handleBlur);
                    window.removeEventListener('focus', handleFocus);
                    document.removeEventListener('copy', preventDefault);
                    document.removeEventListener('cut', preventDefault);
                    document.removeEventListener('paste', preventDefault);
                    document.body.classList.remove('security-blur');
                };
            }, [protectDevTools, protectCopyPaste, protectContextMenu, protectFocus]);
        };

        // --- UTILS: SHUFFLE / PENGACAK ---
        const shuffleArray = (array) => {
            const newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        };

        const shuffleOptionsInQuestion = (q) => {
            if (q.type === 'truefalse') return q;
            
            const optionsWithIndex = q.options.map((opt, idx) => ({ text: opt, originalIndex: idx }));
            const shuffledOptions = shuffleArray(optionsWithIndex);
            const newOptionTexts = shuffledOptions.map(o => o.text);
            const newCorrectAnswer = q.correctAnswer.map(oldAnsIdx => {
                return shuffledOptions.findIndex(item => item.originalIndex === oldAnsIdx);
            }).sort();

            return { ...q, options: newOptionTexts, correctAnswer: newCorrectAnswer };
        };

        // --- ICON HELPER ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (iconRef.current && window.lucide) {
                    const iconName = name.replace(/([a-z0-9])([A-Z])/g, '$1-$2').toLowerCase();
                    iconRef.current.innerHTML = `<i data-lucide="${iconName}"></i>`;
                    window.lucide.createIcons({
                        root: iconRef.current,
                        attrs: { width: size, height: size, class: className, "stroke-width": 2 }
                    });
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        // Icons
        const Shield = (p) => <Icon name="Shield" {...p} />;
        const AlertTriangle = (p) => <Icon name="AlertTriangle" {...p} />;
        const CheckCircle = (p) => <Icon name="CheckCircle" {...p} />;
        const Clock = (p) => <Icon name="Clock" {...p} />;
        const LogOut = (p) => <Icon name="LogOut" {...p} />;
        const User = (p) => <Icon name="User" {...p} />;
        const Plus = (p) => <Icon name="Plus" {...p} />;
        const Trash2 = (p) => <Icon name="Trash2" {...p} />;
        const Eye = (p) => <Icon name="Eye" {...p} />;
        const EyeOff = (p) => <Icon name="EyeOff" {...p} />;
        const FileText = (p) => <Icon name="FileText" {...p} />;
        const Maximize = (p) => <Icon name="Maximize" {...p} />;
        const Lock = (p) => <Icon name="Lock" {...p} />;
        const Info = (p) => <Icon name="Info" {...p} />;
        const List = (p) => <Icon name="List" {...p} />;
        const XCircle = (p) => <Icon name="XCircle" {...p} />;
        const HelpCircle = (p) => <Icon name="HelpCircle" {...p} />;
        const Upload = (p) => <Icon name="Upload" {...p} />;
        const Download = (p) => <Icon name="Download" {...p} />;
        const ImageIcon = (p) => <Icon name="Image" {...p} />;
        const Clipboard = (p) => <Icon name="Clipboard" {...p} />;
        const Edit3 = (p) => <Icon name="Edit3" {...p} />;
        const FileUp = (p) => <Icon name="FileUp" {...p} />;
        const LayoutDashboard = (p) => <Icon name="LayoutDashboard" {...p} />;
        const Users = (p) => <Icon name="Users" {...p} />;
        const BookOpen = (p) => <Icon name="BookOpen" {...p} />;
        const Calendar = (p) => <Icon name="Calendar" {...p} />;
        const Menu = (p) => <Icon name="Menu" {...p} />;
        const X = (p) => <Icon name="X" {...p} />;
        const Printer = (p) => <Icon name="Printer" {...p} />;
        const ChevronRight = (p) => <Icon name="ChevronRight" {...p} />;
        const School = (p) => <Icon name="School" {...p} />;
        const Save = (p) => <Icon name="Save" {...p} />;
        const RotateCcw = (p) => <Icon name="RotateCcw" {...p} />;
        const FileSpreadsheet = (p) => <Icon name="FileSpreadsheet" {...p} />;
        const ArrowLeft = (p) => <Icon name="ArrowLeft" {...p} />;
        const FileDown = (p) => <Icon name="FileDown" {...p} />;
        const CloudUpload = (p) => <Icon name="CloudUpload" {...p} />;
        const FileSearch = (p) => <Icon name="FileSearch" {...p} />;
        const Check = (p) => <Icon name="Check" {...p} />;
        const Zap = (p) => <Icon name="Zap" {...p} />;
        const RefreshCw = (p) => <Icon name="RefreshCw" {...p} />;
        const MoreVertical = (p) => <Icon name="MoreVertical" {...p} />;
        const CreditCard = (p) => <Icon name="CreditCard" {...p} />;
        const Loader = (p) => <Icon name="Loader" {...p} />;
        const Grid = (p) => <Icon name="Grid" {...p} />;
        const Flag = (p) => <Icon name="Flag" {...p} />;
        const History = (p) => <Icon name="History" {...p} />;
        const PlayCircle = (p) => <Icon name="PlayCircle" {...p} />;
        const CheckSquareIcon = (p) => <Icon name="CheckSquare" {...p} />;
        const Settings = (p) => <Icon name="Settings" {...p} />;
        const Search = (p) => <Icon name="Search" {...p} />;
        const UserCog = (p) => <Icon name="UserCog" {...p} />;
        const Minimize = (p) => <Icon name="Minimize" {...p} />;
        const Database = (p) => <Icon name="Database" {...p} />;
        const Cloud = (p) => <Icon name="Cloud" {...p} />;
        const CloudOff = (p) => <Icon name="CloudOff" {...p} />;
        const WifiOff = (p) => <Icon name="WifiOff" {...p} />;

        // --- UTILS STORAGE (VERSI ENTERPRISE HEMAT MEMORI) ---
        const secureStorage = {
            setItem: (key, value) => {
                try {
                    const stringValue = JSON.stringify(value);
                    if (key.includes('siujang_qs_')) {
                        localStorage.setItem(key, stringValue); 
                    } else {
                        const encodedValue = btoa(unescape(encodeURIComponent(stringValue))); 
                        localStorage.setItem(key, encodedValue); 
                    }
                } catch (e) { 
                    if (e.name === 'QuotaExceededError') {
                         alert("Peringatan: Memori Browser HP Anda penuh! Beberapa jawaban terakhir mungkin gagal disimpan ke memori offline.");
                    }
                }
            },
            getItem: (key, defaultValue) => {
                try {
                    const val = localStorage.getItem(key);
                    if (!val) return defaultValue;
                    if (val.startsWith('{') || val.startsWith('[')) return JSON.parse(val);
                    const decodedValue = decodeURIComponent(escape(atob(val))); 
                    return JSON.parse(decodedValue);
                } catch (e) { 
                    try { return JSON.parse(localStorage.getItem(key)); } catch(err) { return defaultValue; }
                }
            },
            removeItem: (key) => localStorage.removeItem(key)
        };

        const INITIAL_USERS = [
          { username: "admin", password: "123", role: "admin", name: "Administrator Utama", nis: "-", class: "-" },
          { username: "101", password: "123", role: "student", name: "Andi Saputra", nis: "101", class: "X-A" }
        ];

        const INITIAL_QUESTIONS = [
          {
            id: 1, type: 'single', 
            question: "Siapakah presiden pertama Indonesia?",
            options: ["Ir. Soekarno", "B.J. Habibie", "Soeharto", "Megawati", "Jokowi"],
            correctAnswer: [0], questionImages: [], optionImages: [[], [], [], [], []] 
          }
        ];

        const INITIAL_BANKS = [{ id: 'bank_default', code: 'UJI-001', subject: 'Pengetahuan Umum', date: '2024-01-01', questions: INITIAL_QUESTIONS }];

        const INITIAL_SCHOOL_PROFILE = {
          examName: "SI UJANG PRO (Ujian Anti Curang)",
          logoUrl: "", 
          schoolName: "Solusi Digitalisasi Evaluasi Pembelajaran Berbasis Integritas",
          address: "Jl. Pendidikan No. 123, Kabupaten Grobogan, Indonesia",
          headmaster: "Drs. Anis Faozi, M.Pd.",
          nip: "19910101 201501 1 001"
        };

        const loadData = (key, defaultValue) => {
            const raw = localStorage.getItem(key);
            if (!raw) return defaultValue;
            try { return JSON.parse(decodeURIComponent(escape(atob(raw)))); } catch {
                try { return JSON.parse(raw); } catch { return defaultValue; }
            }
        };

        const useNetworkStatus = () => {
          const [isOnline, setIsOnline] = useState(true);
          useEffect(() => {
            if (typeof window !== 'undefined') {
              setIsOnline(navigator.onLine);
              const handleOnline = () => setIsOnline(true);
              const handleOffline = () => setIsOnline(false);
              window.addEventListener('online', handleOnline);
              window.addEventListener('offline', handleOffline);
              return () => {
                window.removeEventListener('online', handleOnline);
                window.removeEventListener('offline', handleOffline);
              };
            }
          }, []);
          return isOnline;
        };

        // --- COMPONENTS ---

        function Toast({ message, type, onClose }) {
          useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
          let bgClass = 'bg-gray-800'; let IconComp = Info;
          if (type === 'error') { bgClass = 'bg-red-500'; IconComp = AlertTriangle; }
          else if (type === 'success') { bgClass = 'bg-emerald-500'; IconComp = CheckCircle; }
          else if (type === 'warning') { bgClass = 'bg-orange-500'; IconComp = WifiOff; }

          return (
            <div className={`fixed bottom-4 right-4 ${bgClass} text-white px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-fade-in z-[99999]`}>
              <IconComp size={20}/> <span className="font-bold text-sm">{message}</span>
            </div>
          );
        }

        function SidebarItem({ icon, label, active, onClick }) { 
            return (
              <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm transition ${active ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-400 hover:bg-gray-800'}`}>
                {icon} <span>{label}</span>
              </button>
            );
        }

        function AuthScreen({ onLogin, users, schoolProfile, notify }) {
          const [u, setU] = useState(''); const [p, setP] = useState(''); const [showPassword, setShowPassword] = useState(false);
          const handleLogin = (e) => { 
            e.preventDefault();
            const user = users.find(x => x.username === u.trim() && x.password === p.trim()); 
            if(user) onLogin(user); 
            else notify("Otentikasi Gagal! Periksa username/password.", "error");
          };
          return (
            <div className="flex items-center justify-center min-h-[85vh] px-4 py-12 relative">
              <form onSubmit={handleLogin} className="bg-white p-8 md:p-10 rounded-[2.5rem] shadow-2xl w-full max-w-sm border-4 border-indigo-50 relative overflow-hidden z-10">
                <div className="absolute top-0 right-0 w-24 h-24 bg-indigo-50 rounded-bl-[4rem] opacity-30"></div>
                <div className="text-center mb-10 relative z-10">
                    <div className="w-20 h-20 bg-indigo-600 rounded-3xl rotate-12 flex items-center justify-center mx-auto mb-6 shadow-2xl shadow-indigo-200">
                        <Shield size={40} className="text-white -rotate-12" />
                    </div>
                    <h2 className="text-xl font-black text-gray-800 leading-tight uppercase mb-2">{schoolProfile.examName}</h2>
                    <div className="flex items-center justify-center gap-2">
                        <div className="h-0.5 w-4 bg-indigo-200 rounded-full"></div>
                        <p className="text-[9px] text-indigo-500 font-bold uppercase tracking-wider">{schoolProfile.schoolName}</p>
                        <div className="h-0.5 w-4 bg-indigo-200 rounded-full"></div>
                    </div>
                </div>
                <div className="space-y-4 relative z-10">
                    <div className="relative group">
                        <User className="absolute left-4 top-4 text-gray-400 group-focus-within:text-indigo-600 transition" size={20} />
                        <input className="w-full p-4 pl-12 border-2 border-gray-100 rounded-2xl outline-none focus:ring-4 focus:ring-indigo-50 focus:border-indigo-500 transition font-bold" placeholder="Username / NIS" value={u} onChange={e=>setU(e.target.value)} required />
                    </div>
                    <div className="relative group">
                        <Lock className="absolute left-4 top-4 text-gray-400 group-focus-within:text-indigo-600 transition" size={20} />
                        <input className="w-full p-4 pl-12 pr-12 border-2 border-gray-100 rounded-2xl outline-none focus:ring-4 focus:ring-indigo-50 focus:border-indigo-500 transition font-bold" type={showPassword ? "text" : "password"} placeholder="Password" value={p} onChange={e=>setP(e.target.value)} required />
                        <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-4 top-4 text-gray-400 hover:text-indigo-600 transition focus:outline-none">
                          {showPassword ? <EyeOff size={20} /> : <Eye size={20} />}
                        </button>
                    </div>
                    <button className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-2xl shadow-indigo-200 hover:bg-indigo-700 transition active:scale-95 text-lg flex items-center justify-center gap-2">Login Sekarang <PlayCircle size={20}/></button>
                 </div>
              </form>
              <div className="absolute bottom-4 text-center opacity-40 text-[10px] font-mono">
                <p>Protected by Si Ujang Secure Engine™</p>
              </div>
            </div>
          );
        }

        function AdminJadwalUjian({ schedules, setSchedules, users, questionBanks, notify }) { 
            const [showModal, setShowModal] = useState(false);
            const [form, setForm] = useState({ 
                id: '', name: '', bankId: '', date: '', time: '', duration: 60, token: '', classes: [],
                randomizeQuestions: true, randomizeOptions: false 
            });

            const availableClasses = ['Semua Kelas', ...new Set(users.filter(u => u.role === 'student').map(u => u.class))].sort();
            const generateToken = () => { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let t = ''; for (let i = 0; i < 5; i++) { t += chars.charAt(Math.floor(Math.random() * chars.length)); } return t; };
            
            const handleOpenModal = () => { 
                setForm({ id: Date.now(), name: '', bankId: '', date: '', time: '', duration: 60, token: generateToken(), classes: [], randomizeQuestions: true, randomizeOptions: false }); 
                setShowModal(true); 
            }; 
            const handleEdit = (schedule) => { setForm({ ...schedule }); setShowModal(true); };
            const toggleClass = (c) => { setForm(prev => { const isSelected = prev.classes.includes(c); if (isSelected) return { ...prev, classes: prev.classes.filter(item => item !== c) }; else return { ...prev, classes: [...prev.classes, c] }; }); }; 
            
            const handleSave = () => { 
                if(!form.name || !form.bankId || !form.date || !form.time || form.classes.length === 0 || !form.token) return notify("Lengkapi data jadwal & token!", "error"); 
                const selectedBank = questionBanks.find(b => b.id === form.bankId); 
                const bankName = selectedBank ? selectedBank.subject : 'Unknown Bank'; 
                setSchedules(prev => { const exists = prev.some(s => s.id === form.id); if (exists) return prev.map(s => s.id === form.id ? { ...form, bankName } : s); return [...prev, { ...form, bankName }]; }); 
                setShowModal(false); notify("Jadwal tersimpan."); 
            }; 

            return ( 
                <div className="space-y-6 animate-fade-in text-gray-800"> 
                    <div className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl border shadow-sm gap-4"><div><h3 className="font-bold text-lg text-gray-800">Jadwal Ujian</h3></div><button onClick={handleOpenModal} className="w-full md:w-auto bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg">Buat Jadwal Baru</button></div> 
                    <div className="bg-white rounded-2xl border shadow-sm overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-white border-b"><tr><th className="p-4 font-bold uppercase text-xs">Nama Ujian</th><th className="p-4 font-bold uppercase text-xs">Bank Soal</th><th className="p-4 font-bold uppercase text-xs">Waktu</th><th className="p-4 font-bold uppercase text-xs text-center">Set</th><th className="p-4 font-bold uppercase text-xs text-center">Token</th><th className="p-4 font-bold uppercase text-xs text-center">Aksi</th></tr></thead><tbody className="divide-y divide-gray-100">{schedules.map((s, i) => (<tr key={i} className="hover:bg-gray-50"><td className="p-4 font-bold text-gray-800">{s.name}</td><td className="p-4 text-indigo-600">{s.bankName}</td><td className="p-4 text-gray-500">{s.date} ({s.duration}m)</td><td className="p-4 text-center"><div className="flex flex-col items-center gap-1"><span className={`text-[10px] font-bold px-2 py-0.5 rounded ${s.randomizeQuestions ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-400'}`}>Acak Soal</span><span className={`text-[10px] font-bold px-2 py-0.5 rounded ${s.randomizeOptions ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-400'}`}>Acak Opsi</span></div></td><td className="p-4 text-center font-mono text-orange-600 font-bold bg-orange-50/50 rounded">{s.token}</td><td className="p-4 text-center"><div className="flex items-center justify-center gap-2"><button onClick={() => handleEdit(s)} className="text-indigo-600 p-2 hover:bg-indigo-50 rounded-lg"><Edit3 size={16}/></button><button onClick={() => setSchedules(prev => prev.filter(x=>x.id!==s.id))} className="text-red-500 p-2 hover:bg-red-50 rounded-lg"><Trash2 size={16}/></button></div></td></tr>))}</tbody></table></div></div> 
                    {showModal && ( 
                        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white rounded-2xl w-[95%] md:w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto"><div className="flex justify-between items-center p-6 border-b bg-gray-50"><h3 className="font-bold text-xl text-gray-800">Konfigurasi Ujian</h3><button onClick={() => setShowModal(false)} className="text-gray-400 hover:text-red-500 transition"><X size={24}/></button></div><div className="p-8 space-y-6"><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Nama Sesi</label><input className="w-full p-3 rounded-xl border bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition" placeholder="Contoh: PAS Matematika" value={form.name} onChange={e => setForm({...form, name: e.target.value})} /></div><div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Paket Soal</label><select className="w-full p-3 rounded-xl border bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition" value={form.bankId} onChange={e => setForm({...form, bankId: e.target.value})}><option value="">-- Pilih Bank Soal --</option>{questionBanks.map(b => (<option key={b.id} value={b.id}>{b.subject}</option>))}</select></div></div><div className="grid grid-cols-2 md:grid-cols-4 gap-4"><div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Tanggal</label><input type="date" className="w-full p-3 rounded-xl border bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm" value={form.date} onChange={e => setForm({...form, date: e.target.value})} /></div><div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Jam</label><input type="time" className="w-full p-3 rounded-xl border bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition text-sm" value={form.time} onChange={e => setForm({...form, time: e.target.value})} /></div><div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Durasi (Mnt)</label><input type="number" className="w-full p-3 rounded-xl border bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition text-center font-bold" value={form.duration} onChange={e => setForm({...form, duration: e.target.value})} /></div><div className="space-y-1"><label className="text-xs font-bold text-gray-400 uppercase">Token</label><div className="flex relative"><input type="text" className="w-full p-3 rounded-xl border bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition text-center font-mono font-bold text-indigo-600 uppercase tracking-widest" value={form.token} onChange={e => setForm({...form, token: e.target.value.toUpperCase()})} maxLength={5} /><button type="button" onClick={() => setForm({...form, token: generateToken()})} className="absolute right-2 top-2 p-1.5 bg-gray-100 rounded-lg hover:bg-gray-200 text-gray-500 transition" title="Acak Token"><RefreshCw size={14}/></button></div></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-xl border border-gray-200"><label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" className="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500" checked={form.randomizeQuestions} onChange={e => setForm({...form, randomizeQuestions: e.target.checked})} /><div><span className="block text-sm font-bold text-gray-700">Acak Urutan Soal</span><span className="text-xs text-gray-500">Nomor soal akan berbeda tiap siswa.</span></div></label><label className="flex items-center gap-3 cursor-pointer"><input type="checkbox" className="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500" checked={form.randomizeOptions} onChange={e => setForm({...form, randomizeOptions: e.target.checked})} /><div><span className="block text-sm font-bold text-gray-700">Acak Pilihan Jawaban</span><span className="text-xs text-gray-500">Urutan A, B, C, D, E akan diacak.</span></div></label></div><div className="space-y-2"><label className="text-xs font-bold text-gray-400 uppercase">Peserta Kelas</label><div className="flex flex-wrap gap-2 p-4 border rounded-xl bg-gray-50 max-h-32 overflow-y-auto">{availableClasses.map(cls => (<button key={cls} onClick={() => toggleClass(cls)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition shadow-sm ${form.classes.includes(cls) ? 'bg-indigo-600 text-white border-indigo-600 ring-2 ring-indigo-200' : 'bg-white text-gray-600 border-gray-200 hover:border-indigo-300'}`}>{cls}</button>))}</div></div></div><div className="p-6 border-t bg-white flex justify-end gap-3"><button onClick={() => setShowModal(false)} className="px-6 py-3 border rounded-xl font-bold text-gray-500 hover:bg-gray-50 transition">Batal</button><button onClick={handleSave} className="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition flex items-center gap-2"><Save size={18}/> Simpan Jadwal</button></div></div></div> 
                    )} 
                </div> 
            );
        }

        function StudentDashboard({ user, schedules, results, onStartExam, pendingResults, onSyncPending, notify }) {
          const isOnline = useNetworkStatus();
          const mySchedules = schedules.filter(s => s.classes.includes(user.class) || s.classes.includes("Semua"));
          const isExamDone = (scheduleId) => {
              return results.some(r => r.studentName === user.name && r.scheduleId === scheduleId) ||
                     pendingResults.some(r => r.studentName === user.name && r.scheduleId === scheduleId);
          };
          const completed = mySchedules.filter(s => isExamDone(s.id));
          const pending = mySchedules.filter(s => !isExamDone(s.id));
          const myPendingResults = pendingResults.filter(r => r.studentName === user.name);
          const [selectedExam, setSelectedExam] = useState(null); 
          const [tokenInput, setTokenInput] = useState('');
          const handleInitExam = (schedule) => { setSelectedExam(schedule); setTokenInput(''); };
          
          const handleVerifyToken = (e) => { 
              e.preventDefault();
              if (!tokenInput) return notify("Masukkan token ujian!", "error"); 
              if (tokenInput.toUpperCase() === selectedExam.token) { 
                  const elemen = document.documentElement;
                  if (elemen.requestFullscreen) elemen.requestFullscreen().catch(err => console.log(err));
                  else if (elemen.webkitRequestFullscreen) elemen.webkitRequestFullscreen();
                  else if (elemen.msRequestFullscreen) elemen.msRequestFullscreen();
                  onStartExam(selectedExam.id); 
                  setSelectedExam(null); 
              } 
              else { notify("Token Ujian Salah! Silakan tanya pengawas.", "error"); } 
          };
          const resumeExamId = secureStorage.getItem(`siujang_progress_id_${user.username}`);
          const resumeExamSchedule = resumeExamId ? schedules.find(s => s.id === parseInt(resumeExamId)) : null;

          return (
            <div className="space-y-8 animate-fade-in p-4 md:p-0">
              {selectedExam && (<div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/60 p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white p-8 rounded-3xl w-full max-w-sm shadow-2xl border-4 border-indigo-50 text-center relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-2 bg-indigo-500"></div><div className="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-600 animate-pulse"><Lock size={40}/></div><h3 className="text-xl font-bold text-gray-800 mb-2">Verifikasi Token</h3><p className="text-xs text-gray-500 mb-6">Masukkan token ujian untuk mengakses soal <strong>{selectedExam.name}</strong>.</p><form onSubmit={handleVerifyToken} className="space-y-4"><input type="text" maxLength={5} className="w-full p-4 text-center text-3xl font-mono font-bold tracking-[0.5em] uppercase border-2 border-gray-200 rounded-2xl outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition text-gray-700 placeholder-gray-200" placeholder="_____" value={tokenInput} onChange={(e) => setTokenInput(e.target.value.toUpperCase())} autoFocus /><div className="flex gap-2"><button type="button" onClick={() => setSelectedExam(null)} className="flex-1 py-3 border rounded-xl font-bold text-gray-500 hover:bg-gray-50 transition">Batal</button><button type="submit" className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2">Mulai <ChevronRight size={18}/></button></div></form></div></div>)}
              {myPendingResults.length > 0 && (
                <div className="bg-yellow-50 border-2 border-yellow-200 p-5 rounded-2xl flex flex-col sm:flex-row items-center justify-between shadow-lg gap-4">
                   <div className="flex items-center gap-4">
                      <div className="bg-yellow-100 p-3 rounded-full text-yellow-600"><CloudUpload size={24}/></div>
                      <div>
                          <h4 className="font-bold text-yellow-800 text-lg">Menunggu Upload ({myPendingResults.length})</h4>
                          <p className="text-xs text-yellow-600 font-medium">Ada hasil ujian yang belum terkirim ke server karena koneksi.</p>
                      </div>
                   </div>
                   <button onClick={onSyncPending} disabled={!isOnline} className={`px-6 py-3 rounded-xl font-bold text-sm flex items-center gap-2 shadow-md transition ${isOnline ? 'bg-yellow-500 text-white hover:bg-yellow-600' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}`}>
                     {isOnline ? <><RefreshCw size={18}/> Upload Sekarang</> : <><WifiOff size={18}/> Tunggu Sinyal</>}
                   </button>
                </div>
              )}
              {resumeExamSchedule && (
                 <div className="bg-orange-50 border border-orange-200 p-4 rounded-xl flex items-center justify-between shadow-sm animate-pulse">
                    <div className="flex items-center gap-3">
                       <AlertTriangle className="text-orange-500"/>
                       <div>
                          <h4 className="font-bold text-orange-800">Ujian Belum Selesai!</h4>
                          <p className="text-xs text-orange-600">Anda memiliki sesi {resumeExamSchedule.name} yang belum disubmit.</p>
                       </div>
                    </div>
                    <button onClick={() => {
                        const elemen = document.documentElement;
                        if (elemen.requestFullscreen) elemen.requestFullscreen().catch(err => console.log(err));
                        else if (elemen.webkitRequestFullscreen) elemen.webkitRequestFullscreen();
                        else if (elemen.msRequestFullscreen) elemen.msRequestFullscreen();
                        onStartExam(resumeExamSchedule.id)
                    }} className="bg-orange-500 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-orange-600">Lanjutkan</button>
                 </div>
              )}
              <div className="bg-white p-6 md:p-8 rounded-3xl shadow-lg border border-indigo-50 flex flex-col md:flex-row justify-between items-center relative overflow-hidden"><div className="relative z-10 text-center md:text-left mb-4 md:mb-0"><h1 className="text-2xl md:text-3xl font-bold text-gray-900">Selamat Mengerjakan, {user.name.split(' ')[0]}!</h1><p className="text-gray-500 mt-1 font-medium">Kelas: {user.class} | Status: Aktif</p></div><div className="p-5 bg-indigo-50 rounded-2xl relative z-10 text-center md:text-right border border-indigo-100 w-full md:w-auto"><p className="text-3xl font-bold text-indigo-700">{pending.length}</p><p className="text-[10px] font-bold text-indigo-500 uppercase tracking-widest">UJIAN AKTIF</p></div><LayoutDashboard className="absolute -right-8 -bottom-8 w-48 h-48 opacity-5 text-indigo-600" /></div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8"><div><h3 className="font-bold flex items-center gap-2 mb-4 text-gray-700 uppercase tracking-widest text-[11px]"><PlayCircle size={16} className="text-indigo-600"/> Jadwal Tersedia</h3><div className="space-y-4">{pending.length === 0 ? (<div className="text-center py-12 bg-white rounded-2xl border border-dashed text-gray-400"><Calendar className="mx-auto mb-2 opacity-30" size={40}/><p>Belum ada jadwal ujian aktif.</p></div>) : pending.map(s => (<div key={s.id} className="bg-white p-5 rounded-2xl border-2 border-indigo-50 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center hover:border-indigo-200 transition gap-4"><div><h4 className="font-bold text-gray-800 text-lg">{s.name}</h4><p className="text-xs text-gray-500 font-medium">{s.bankName} | Durasi: {s.duration} Menit</p></div><button onClick={() => handleInitExam(s)} className="w-full sm:w-auto bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition active:scale-95">Mulai</button></div>))}</div></div><div><h3 className="font-bold flex items-center gap-2 mb-4 text-gray-700 uppercase tracking-widest text-[11px]"><History size={16} className="text-emerald-600"/> Riwayat Hasil</h3><div className="space-y-4">{completed.length === 0 ? (<div className="text-center py-12 bg-white rounded-2xl border border-dashed text-gray-400"><History className="mx-auto mb-2 opacity-30" size={40}/><p>Belum ada ujian yang selesai.</p></div>) : completed.map(s => { const res = results.find(r => r.studentName === user.name && r.scheduleId === s.id) || pendingResults.find(r => r.studentName === user.name && r.scheduleId === s.id); return (<div key={s.id} className="bg-white p-5 rounded-2xl border border-gray-100 flex justify-between items-center opacity-70"><div><h4 className="font-bold text-gray-700">{s.name}</h4><p className="text-xs text-gray-400">{res?.date}</p></div><div className="text-right"><p className="text-3xl font-bold text-gray-800 leading-none">{res?.score}</p><p className="text-[8px] font-bold uppercase text-indigo-500 tracking-tighter">SCORE</p></div></div>); })}</div></div></div>
            </div>
          );
        }

        function ExamPortal({ user, questions, onSubmit, notify, schoolProfile, examInfo }) {
          const isOnline = useNetworkStatus();
          const [idx, setIdx] = useState(0);
          const [ans, setAns] = useState({}); 
          const [flags, setFlags] = useState({});
          const [time, setTime] = useState(examInfo ? examInfo.duration * 60 : 3600); 
          const [isNavOpen, setIsNavOpen] = useState(false);
          const [isInitialized, setIsInitialized] = useState(false);
          const [showConfirmFinish, setShowConfirmFinish] = useState(false);
          const ansRef = useRef({});
          const questionsRef = useRef([]);
          
          const MAX_VIOLATIONS = 3;
          const [cheatCount, setCheatCount] = useState(0);
          const [cheatLogs, setCheatLogs] = useState([]); 
          const cheatCountRef = useRef(0);
          const cheatLogsRef = useRef([]); 
          const [violationMsg, setViolationMsg] = useState("Fokus hilang!");
          const [showCheatAlert, setShowCheatAlert] = useState(false);
          const [isFullscreen, setIsFullscreen] = useState(true);
          const containerRef = useRef(null);
          
          const questionsKey = examInfo ? `siujang_qs_${examInfo.id}` : null;
          const storageKey = examInfo ? `siujang_progress_${examInfo.id}_${user.username}` : null;
          const resumeKey = `siujang_progress_id_${user.username}`;
          
          useEffect(() => { ansRef.current = ans; }, [ans]);
          useEffect(() => { 
              if (questions && questions.length > 0) {
                  questionsRef.current = questions;
              } else if (questionsKey) {
                  try {
                      const cached = secureStorage.getItem(questionsKey, []);
                      if (cached.length > 0) questionsRef.current = cached;
                  } catch(e) {}
              }
          }, [questions, questionsKey]);
          
          useEffect(() => {
            if (!storageKey || !questionsKey) return;
            if (questions && questions.length > 0) {
                secureStorage.setItem(questionsKey, questions);
                questionsRef.current = questions;
            } else {
                try {
                    const cached = secureStorage.getItem(questionsKey, []);
                    if (cached.length > 0) questionsRef.current = cached;
                } catch(e) {}
            }
            const saved = secureStorage.getItem(storageKey);
            if (saved) {
              try {
                if (saved.ans) { setAns(saved.ans); ansRef.current = saved.ans; }
                if (saved.flags) setFlags(saved.flags);
                if (saved.idx !== undefined) setIdx(saved.idx);
                if (saved.time) setTime(saved.time);
                if (saved.cheatCount) {
                    setCheatCount(saved.cheatCount);
                    cheatCountRef.current = saved.cheatCount;
                }
                if (saved.cheatLogs) {
                    setCheatLogs(saved.cheatLogs);
                    cheatLogsRef.current = saved.cheatLogs;
                }
                notify("Progress dipulihkan.", "success");
              } catch (e) {}
            }
            secureStorage.setItem(resumeKey, examInfo.id);
            setIsInitialized(true);
          }, [storageKey, questionsKey, questions]);

          useEffect(() => {
            if (!isInitialized || !storageKey) return;
            const data = { ans, flags, idx, time, cheatCount, cheatLogs };
            secureStorage.setItem(storageKey, data);
          }, [ans, flags, idx, time, cheatCount, cheatLogs, isInitialized, storageKey]);
          
          const submitFinal = (isAuto = false) => {
            const currentAns = ansRef.current;
            const currentQuestions = questionsRef.current;
            if (!currentQuestions || currentQuestions.length === 0) {
                notify("Gagal mengumpulkan data.", "error"); return;
            }
            let s = 0;
            currentQuestions.forEach(q => { 
                const userAns = currentAns[q.id];
                const correct = q.correctAnswer;
                if (!userAns) return; 
                let isCorrect = false;
                if (q.type === 'truefalse') { 
                   isCorrect = JSON.stringify(userAns) === JSON.stringify(correct);
                } else { 
                   const sortedUser = [...userAns].sort();
                   const sortedCorrect = [...correct].sort();
                   isCorrect = JSON.stringify(sortedUser) === JSON.stringify(sortedCorrect);
                }
                if (isCorrect) s += 1;
            });
            if(storageKey) secureStorage.removeItem(storageKey);
            secureStorage.removeItem(resumeKey);
            
            if (document.fullscreenElement && document.exitFullscreen) {
                document.exitFullscreen().catch(e => console.log(e));
            }

            onSubmit({ 
                studentName: user.name, 
                score: Math.round((s/currentQuestions.length)*100), 
                cheatCount: cheatCountRef.current,
                cheatLogs: cheatLogsRef.current, 
                answers: currentAns 
            });
            if(isAuto) notify("Ujian dikumpulkan otomatis.");
          };

          useEffect(() => { 
              const t = setInterval(() => {
                  setTime(p => {
                      if (p <= 0) {
                          clearInterval(t); submitFinal(true); return 0;
                      }
                      return p - 1;
                  });
              }, 1000); 
              return () => clearInterval(t); 
          }, []);

          useEffect(() => {
              let wakeLock = null;
              const requestWakeLock = async () => {
                  try {
                      if ('wakeLock' in navigator) {
                          wakeLock = await navigator.wakeLock.request('screen');
                      }
                  } catch (err) {}
              };
              requestWakeLock();
              const handleVisibilityChange = () => {
                  if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock();
              };
              document.addEventListener('visibilitychange', handleVisibilityChange);
              return () => {
                  if (wakeLock !== null) wakeLock.release().then(() => { wakeLock = null; });
                  document.removeEventListener('visibilitychange', handleVisibilityChange);
              };
          }, []);

          useEffect(() => {
              const handleBeforeUnload = (e) => {
                  e.preventDefault();
                  e.returnValue = "Jika Anda keluar, ujian otomatis selesai!";
                  return "Jika Anda keluar, ujian otomatis selesai!";
              };

              const handleUnload = () => {
                  const isStillExamining = secureStorage.getItem(`siujang_progress_id_${user.username}`);
                  if (!isStillExamining) return;

                  const currentAns = ansRef.current;
                  const currentQuestions = questionsRef.current;
                  if (!currentQuestions || currentQuestions.length === 0) return;
                  
                  let s = 0;
                  currentQuestions.forEach(q => { 
                      const userAns = currentAns[q.id];
                      const correct = q.correctAnswer;
                      if (!userAns) return; 
                      let isCorrect = false;
                      if (q.type === 'truefalse') { 
                         isCorrect = JSON.stringify(userAns) === JSON.stringify(correct);
                      } else { 
                         const sortedUser = [...userAns].sort();
                         const sortedCorrect = [...correct].sort();
                         isCorrect = JSON.stringify(sortedUser) === JSON.stringify(sortedCorrect);
                      }
                      if (isCorrect) s += 1;
                  });
                  const finalScore = Math.round((s/currentQuestions.length)*100);
                  
                  const newResult = { 
                      studentName: user.name, 
                      score: finalScore, 
                      cheatCount: cheatCountRef.current,
                      cheatLogs: cheatLogsRef.current, 
                      answers: currentAns,
                      scheduleId: examInfo?.id,
                      scheduleName: examInfo?.name || '-',
                      bankName: examInfo?.bankName || '-',
                      date: new Date().toLocaleString()
                  };
                  
                  try {
                      const existingPendingRaw = localStorage.getItem('siujang_pending_uploads');
                      let existingPending = [];
                      if (existingPendingRaw) existingPending = JSON.parse(existingPendingRaw);
                      
                      const isDuplicate = existingPending.some(r => r.studentName === user.name && r.scheduleId === examInfo?.id);
                      if (!isDuplicate) {
                          existingPending.push(newResult);
                          localStorage.setItem('siujang_pending_uploads', JSON.stringify(existingPending));
                      }
                      
                      secureStorage.removeItem(`siujang_progress_id_${user.username}`);
                      if (storageKey) secureStorage.removeItem(storageKey);
                  } catch(e) {}
              };

              window.addEventListener("beforeunload", handleBeforeUnload);
              window.addEventListener("unload", handleUnload);

              return () => {
                  window.removeEventListener("beforeunload", handleBeforeUnload);
                  window.removeEventListener("unload", handleUnload);
              };
          }, [examInfo, storageKey, user]);

          useEffect(() => {
            const handleViolation = (reason) => {
                const currentCount = cheatCountRef.current + 1;
                cheatCountRef.current = currentCount;
                setCheatCount(currentCount);

                const timeStr = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const newLog = `[${timeStr}] ${reason}`;
                const updatedLogs = [...cheatLogsRef.current, newLog];
                cheatLogsRef.current = updatedLogs;
                setCheatLogs(updatedLogs);

                if (currentCount >= MAX_VIOLATIONS) {
                     setViolationMsg(`PELANGGARAN KE-${currentCount}! BATAS TERCAPAI. Ujian dihentikan otomatis.`);
                    setShowCheatAlert(true);
                    setTimeout(() => { submitFinal(true); }, 3000);
                } else {
                    setViolationMsg(`Anda Terdeteksi ${reason}! (Peringatan ${currentCount}/${MAX_VIOLATIONS})`);
                    setShowCheatAlert(true);
                }
            };

            const handleVisibilityChange = () => { if (document.hidden) handleViolation("Ganti Tab / Keluar Aplikasi"); };
            const handlePrintScreen = (e) => { if (e.key === 'PrintScreen' || e.keyCode === 44) { handleViolation("Screenshot / PrintScreen"); } };
            const handleBlur = () => { handleViolation("Fokus Layar Hilang"); };

            const handleFullscreenChange = () => {
                const isFs = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
                setIsFullscreen(isFs);
                if (!isFs) { handleViolation("Keluar Mode Fullscreen"); }
            };

            document.addEventListener("visibilitychange", handleVisibilityChange);
            window.addEventListener("keyup", handlePrintScreen);
            window.addEventListener("blur", handleBlur);
            document.addEventListener("fullscreenchange", handleFullscreenChange);
            document.addEventListener("webkitfullscreenchange", handleFullscreenChange);

            return () => { 
                document.removeEventListener("visibilitychange", handleVisibilityChange); 
                window.removeEventListener("keyup", handlePrintScreen);
                window.removeEventListener("blur", handleBlur);
                document.removeEventListener("fullscreenchange", handleFullscreenChange);
                document.removeEventListener("webkitfullscreenchange", handleFullscreenChange);
            };
          }, []);

          let displayQuestions = questions;
          if ((!displayQuestions || displayQuestions.length === 0) && questionsRef.current.length > 0) {
              displayQuestions = questionsRef.current;
          }

          if (!displayQuestions || displayQuestions.length === 0) {
              return (
                  <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 text-center animate-fade-in">
                      <div className="bg-white p-8 rounded-2xl shadow-xl flex flex-col items-center border border-indigo-100">
                          <Loader size={48} className="text-indigo-600 mb-4 animate-spin"/>
                          <h3 className="text-xl font-bold text-gray-800">Memulihkan Sesi Ujian...</h3>
                          <p className="text-gray-500 text-sm mt-2">Mencoba mengambil soal dari memori lokal (Mode Aman).</p>
                      </div>
                  </div>
              );
          }

          const q = displayQuestions[idx];
          if (!q) { setIdx(0); return null; }

          const isSelected = (optIdx) => (ans[q.id] || []).includes(optIdx);
          const handleAnswer = (optIdx, value = null) => {
              const current = ans[q.id] || [];
              if (q.type === 'complex') { 
                  if (current.includes(optIdx)) { setAns({...ans, [q.id]: current.filter(x => x !== optIdx)}); } 
                  else { setAns({...ans, [q.id]: [...current, optIdx]}); } 
              } else if (q.type === 'truefalse') { 
                  let newArr = [...(ans[q.id] || Array(q.options.length).fill(null))];
                  newArr[optIdx] = value; setAns({...ans, [q.id]: newArr}); 
              } else { 
                  setAns({...ans, [q.id]: [optIdx]});
              }
          };
          const isAnswered = (id) => { 
              if(!ans[id]) return false;
              if (displayQuestions.find(x=>x.id===id).type === 'truefalse') { return ans[id].length === displayQuestions.find(x=>x.id===id).options.length && !ans[id].includes(null); } 
              return ans[id].length > 0; 
          };

          const answeredCount = displayQuestions.filter(q => isAnswered(q.id)).length;
          const unansweredCount = displayQuestions.length - answeredCount;

          return (
            <div ref={containerRef} className="fixed inset-0 w-full h-full flex flex-col md:flex-row overflow-hidden bg-gray-100 select-none z-[9999]">
              <div className="absolute inset-0 z-[60] pointer-events-none overflow-hidden flex flex-wrap content-around justify-around opacity-[0.04]" aria-hidden="true">{Array.from({ length: 15 }).map((_, i) => (<div key={i} className="transform -rotate-12 text-center p-12"><p className="text-2xl font-black text-slate-900 uppercase tracking-widest">{user.name}</p><p className="text-lg font-bold text-slate-900">{user.nis} • {schoolProfile.examName}</p><p className="text-xs font-mono">{new Date().toLocaleDateString()}</p></div>))}</div>
              
              {showConfirmFinish && (
                  <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 p-6 backdrop-blur-sm animate-fade-in">
                      <div className="bg-white p-8 rounded-3xl w-full max-w-sm text-center shadow-2xl border-4 border-indigo-50">
                          <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 ${unansweredCount > 0 ? 'bg-orange-100 text-orange-600' : 'bg-indigo-100 text-indigo-600'}`}>
                              {unansweredCount > 0 ? <AlertTriangle size={32}/> : <CheckCircle size={32}/>}
                          </div>
                          <h3 className="text-xl font-bold text-gray-800 mb-2">Kumpulkan Jawaban?</h3>
                          {unansweredCount > 0 ? (
                              <p className="text-sm text-orange-600 font-bold mb-6">Peringatan: Masih ada {unansweredCount} soal yang belum dijawab! Yakin ingin mengakhiri ujian?</p>
                          ) : (
                              <p className="text-sm text-gray-500 mb-6">Semua soal telah dijawab. Yakin ingin mengakhiri ujian ini sekarang?</p>
                          )}
                          <div className="flex gap-3">
                              <button onClick={() => setShowConfirmFinish(false)} className="flex-1 py-3 border rounded-xl font-bold text-gray-500 hover:bg-gray-50 transition">Batal</button>
                              <button onClick={() => submitFinal(false)} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition">Ya, Selesai</button>
                          </div>
                      </div>
                  </div>
              )}

              {showCheatAlert && (
                  <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/80 p-6 backdrop-blur-md animate-fade-in">
                      <div className="bg-red-600 text-white p-8 rounded-3xl max-w-sm text-center shadow-2xl border-4 border-red-500">
                          <AlertTriangle size={64} className="mx-auto mb-4 text-yellow-300 animate-bounce"/>
                          <h3 className="text-2xl font-black uppercase mb-2">Peringatan Keamanan!</h3>
                          <p className="text-sm font-medium mb-6 leading-relaxed">{violationMsg}</p>
                          {cheatCountRef.current < MAX_VIOLATIONS && (
                                <button onClick={() => {
                                    setShowCheatAlert(false);
                                    const elemen = document.documentElement;
                                    if (elemen.requestFullscreen) elemen.requestFullscreen().catch(err => console.log(err));
                                    else if (elemen.webkitRequestFullscreen) elemen.webkitRequestFullscreen();
                                    else if (elemen.msRequestFullscreen) elemen.msRequestFullscreen();
                                }} className="bg-white text-red-600 px-8 py-3 rounded-xl font-bold hover:bg-gray-100 transition shadow-lg w-full">Kembali ke Ujian</button>
                          )}
                      </div>
                    </div>
              )}

              <div className={`flex-1 flex flex-col bg-white md:m-4 md:rounded-3xl border-0 md:border shadow-xl overflow-hidden relative h-full z-10`}>
                 <div className={`p-4 md:p-5 border-b flex justify-between items-center text-white transition-colors ${isOnline ? 'bg-indigo-600 border-indigo-500' : 'bg-orange-500 border-orange-600'}`}>
                    <div className="flex items-center gap-3"><div className="bg-white/20 p-2 rounded-xl"><BookOpen size={20} className="text-white"/></div><div><h3 className="font-bold text-base md:text-lg uppercase leading-none">{examInfo?.bankName || 'Mata Pelajaran'}</h3><p className="text-[10px] opacity-80 font-bold uppercase tracking-widest flex items-center gap-1">{examInfo?.name || 'Sesi Ujian'} {isOnline ? '' : '• OFFLINE MODE'}</p></div></div>
                    
                    <div className="flex items-center gap-2">
                        <button onClick={() => setShowConfirmFinish(true)} className="hidden md:flex bg-red-500/20 hover:bg-red-500/30 border border-red-400/30 text-white px-3 py-1.5 rounded-lg text-xs font-bold items-center gap-1 transition mr-2"><XCircle size={14}/> Selesai</button>
                        {!isOnline && <div className="bg-white/20 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1"><WifiOff size={14}/> Offline</div>}
                        <div className="flex items-center gap-2 font-mono bg-black/20 px-3 py-1.5 md:px-4 md:py-2 rounded-xl border border-white/10 text-sm md:text-lg font-bold shadow-sm"><Clock size={18} /><span>{Math.floor(time/60)}:{time%60 < 10 ? '0' : ''}{time%60}</span></div>
                        <button onClick={()=>setIsNavOpen(true)} className="md:hidden p-2 bg-white/10 hover:bg-white/20 rounded-xl transition"><Grid size={18}/></button>
                    </div>
                 </div>

                 <div className="p-4 md:p-12 pb-24 md:pb-12 flex-1 overflow-y-auto select-none" onContextMenu={(e)=>e.preventDefault()}><div className="flex items-center gap-3 mb-6"><span className="font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg border border-indigo-100 whitespace-nowrap">SOAL NO {idx+1}</span><span className={`text-xs font-bold px-2 py-1 rounded border whitespace-nowrap ${q.type === 'complex' ? 'bg-purple-100 text-purple-700 border-purple-200' : q.type === 'truefalse' ? 'bg-orange-100 text-orange-700 border-orange-200' : 'bg-blue-100 text-blue-700 border-blue-200'}`}>{q.type === 'complex' ? 'Majemuk' : q.type === 'truefalse' ? 'B/S' : 'PG'}</span></div><div className="text-lg md:text-2xl font-bold mb-6 leading-relaxed text-gray-800 prose prose-lg max-w-none [&_img]:max-w-full [&_img]:h-auto [&_img]:rounded-lg [&_img]:shadow-sm [&_img]:mx-auto [&_img]:my-4 select-none"><div dangerouslySetInnerHTML={{ __html: q.question }} /></div><div className="space-y-4 max-w-3xl">{q.options.map((o, i) => { const currentVal = (ans[q.id] || [])[i]; const isTF = q.type === 'truefalse'; const active = isTF ? false : isSelected(i); if (isTF) { return (<div key={i} className="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border rounded-xl bg-gray-50 hover:bg-white transition gap-4"><div className="flex-1 font-medium text-gray-700 prose prose-sm [&_img]:max-w-[150px] [&_img]:h-auto [&_img]:rounded select-none" dangerouslySetInnerHTML={{ __html: o }} /><div className="flex gap-2 w-full sm:w-auto"><button onClick={() => handleAnswer(i, 'B')} className={`flex-1 sm:flex-none px-6 py-2 rounded-lg font-bold border transition ${currentVal === 'B' ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-400 border-gray-200 hover:border-blue-300'}`}>B</button><button onClick={() => handleAnswer(i, 'S')} className={`flex-1 sm:flex-none px-6 py-2 rounded-lg font-bold border transition ${currentVal === 'S' ? 'bg-red-500 text-white border-red-500' : 'bg-white text-gray-400 border-gray-200 hover:border-red-300'}`}>S</button></div></div>); } else { return (<button key={i} onClick={() => handleAnswer(i)} className={`w-full text-left p-4 border-2 rounded-2xl transition flex gap-4 items-start group ${active ? 'border-indigo-600 bg-indigo-50 ring-2 ring-indigo-100' : 'border-gray-100 hover:border-indigo-200'}`}><span className={`w-10 h-10 rounded-full border-2 flex items-center justify-center font-bold text-lg transition flex-shrink-0 mt-1 ${active ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-gray-50 text-gray-400 group-hover:bg-white'}`}>{q.type === 'complex' ? <CheckSquareIcon size={18}/> : String.fromCharCode(65+i)}</span><div className="flex-1 prose prose-sm max-w-none text-gray-700 [&_img]:max-w-full [&_img]:h-auto [&_img]:rounded [&_img]:border [&_img]:my-2 select-none" dangerouslySetInnerHTML={{ __html: o }} /></button>); } })}</div></div>
                 
                 <div className="p-4 md:p-6 border-t bg-gray-50 flex flex-col-reverse sm:flex-row justify-between items-center gap-3">
                     <button disabled={idx===0} onClick={() => setIdx(idx-1)} className="w-full sm:w-auto px-6 py-3 border-2 rounded-2xl bg-white font-bold hover:bg-gray-100 transition disabled:opacity-30 flex items-center justify-center gap-2"><ArrowLeft size={18}/> Kembali</button>
                     <div className="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                         <label className="flex items-center justify-center gap-2 bg-yellow-50 px-5 rounded-2xl border-2 border-yellow-200 cursor-pointer select-none py-2 hover:bg-yellow-100 transition w-full sm:w-auto"><input type="checkbox" checked={!!flags[q.id]} onChange={()=>setFlags({...flags, [q.id]: !flags[q.id]})} className="w-5 h-5 text-yellow-500 rounded-lg focus:ring-yellow-500" /> <span className="text-sm font-bold text-yellow-700 uppercase tracking-widest">Ragu-ragu</span></label>
                         {idx === displayQuestions.length-1 ? (
                             <button onClick={()=>setShowConfirmFinish(true)} className="w-full sm:w-auto px-10 py-3 bg-green-600 text-white rounded-2xl font-bold shadow-lg shadow-green-100 hover:bg-green-700 transition flex items-center justify-center gap-2">Selesai <CheckCircle size={20}/></button>
                         ) : (
                             <button onClick={() => setIdx(idx+1)} className="w-full sm:w-auto px-10 py-3 bg-indigo-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition flex items-center justify-center gap-2">Lanjut <ChevronRight size={20}/></button>
                         )}
                     </div>
                 </div>
              </div>
              
              {isNavOpen && <div className="fixed inset-0 bg-black/60 z-[9998] md:hidden backdrop-blur-sm transition-opacity" onClick={() => setIsNavOpen(false)}></div>}
              
              <div className={`fixed inset-y-0 right-0 w-[85vw] max-w-sm bg-white shadow-2xl z-[9999] transform transition-transform duration-300 ease-in-out md:relative md:w-80 md:translate-x-0 md:shadow-none md:border-l md:rounded-r-3xl border-gray-100 md:z-auto ${isNavOpen ? 'translate-x-0' : 'translate-x-full'} top-0 h-full flex flex-col`}>
                 <div className="p-5 border-b flex justify-between items-center md:hidden bg-indigo-50">
                     <span className="font-bold text-lg text-indigo-900 flex items-center gap-2"><Grid size={20}/> Navigasi Soal</span>
                     <button onClick={()=>setIsNavOpen(false)} className="p-2 bg-white text-red-500 hover:bg-red-50 hover:text-red-600 rounded-xl shadow-sm border border-red-100 transition"><X size={20}/></button>
                 </div>
                 <div className="p-8 flex-1 overflow-y-auto">
                     <div className="flex items-center gap-2 mb-6"><div className="w-2 h-6 bg-indigo-600 rounded-full"></div><p className="font-bold text-xs text-gray-400 uppercase tracking-widest">Nomor Soal</p></div>
                     <div className="grid grid-cols-5 gap-3">{displayQuestions.map((_, i) => { const statusClass = flags[displayQuestions[i].id] ? 'bg-yellow-400 border-yellow-500 text-yellow-900 shadow-md' : isAnswered(displayQuestions[i].id) ? 'bg-emerald-500 border-emerald-600 text-white shadow-md' : 'bg-gray-50 border-gray-200 text-gray-400'; const activeClass = idx===i ? 'border-indigo-600 bg-white ring-4 ring-indigo-50 text-indigo-600' : statusClass;
                     return (<button key={i} onClick={()=>{setIdx(i); setIsNavOpen(false);}} className={`aspect-square rounded-xl border-2 text-sm font-bold transition flex items-center justify-center relative ${activeClass}`}>{i+1}{flags[displayQuestions[i].id] && <div className="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>}</button>); })}</div>
                     <div className="mt-8 space-y-4">
                         <div className="p-4 bg-red-50 rounded-xl border border-red-100 text-center"><p className="text-[10px] font-bold text-red-500 uppercase tracking-widest mb-1">Status Keamanan</p><div className="text-2xl font-black text-red-600">{cheatCount}/{MAX_VIOLATIONS}</div><p className="text-[9px] text-red-400">Pelanggaran (Max {MAX_VIOLATIONS})</p></div>
                         <button onClick={() => { setIsNavOpen(false); setShowConfirmFinish(true); }} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2"><CheckCircle size={18}/> Kumpulkan Jawaban</button>
                     </div>
                     <div className="mt-6 space-y-3 pt-6 border-t border-dashed mb-20"><div className="flex items-center gap-3 text-xs font-bold text-gray-500"><div className="w-4 h-4 bg-emerald-500 rounded shadow-sm"></div> Sudah Dijawab</div><div className="flex items-center gap-3 text-xs font-bold text-gray-500"><div className="w-4 h-4 bg-yellow-400 rounded shadow-sm"></div> Ragu-ragu</div><div className="flex items-center gap-3 text-xs font-bold text-gray-500"><div className="w-4 h-4 bg-gray-50 border-2 rounded shadow-sm"></div> Belum Dijawab</div></div>
                 </div>
              </div>
              
              <div className="fixed bottom-2 right-2 p-2 opacity-30 pointer-events-none z-[9999] text-[8px] font-mono text-gray-400 mix-blend-multiply bg-white/50 rounded-tl-lg">
                 Si Ujang Secure Engine™ • ID: {user.username}
              </div>
            </div>
          );
        }

        function ResultScreen({ setView }) {
          return (
            <div className="flex items-center justify-center min-h-[60vh] animate-fade-in p-4">
              <div className="bg-white p-12 rounded-[2.5rem] shadow-2xl text-center border-4 border-indigo-50 max-w-sm w-full relative overflow-hidden">
                <div className="absolute -top-10 -right-10 w-40 h-40 bg-indigo-50 rounded-full opacity-50"></div>
                <div className="w-24 h-24 bg-emerald-100 text-emerald-600 rounded-3xl flex items-center justify-center mx-auto mb-8 rotate-12 shadow-lg shadow-emerald-50"><CheckCircle size={48} className="-rotate-12"/></div>
                <h2 className="text-3xl font-black mb-2 text-gray-900">Ujian Berhasil!</h2>
                <p className="text-gray-500 mb-10 text-sm font-medium leading-relaxed">Jawaban Anda sudah tersimpan. Jika sedang offline, jawaban akan terkirim otomatis saat online.</p>
                <button onClick={()=>setView('student_dashboard')} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-indigo-100 hover:bg-indigo-700 transition active:scale-95 flex items-center justify-center gap-2">Dashboard Siswa <ChevronRight size={18}/></button>
              </div>
            </div>
          );
        }

        function AdminSummary({ users, questionBanks, schedules, onGenerate, onFactoryReset, notify }) {
          const [isGenerating, setIsGenerating] = useState(false);
          const [showConfigModal, setShowConfigModal] = useState(false); const [simConfig, setSimConfig] = useState({ count: 10, prefixName: 'Siswa Simulasi', subjectName: 'Ujian Simulasi Komputer' });
          const handleGenerateClick = async () => { if (typeof onGenerate !== 'function') { notify("Fungsi generate belum terhubung.", "error"); return; } setShowConfigModal(false); setIsGenerating(true); try { await onGenerate(simConfig); setTimeout(() => { notify(`✅ Berhasil generate ${simConfig.count} siswa & data ujian!`); }, 100); } catch (error) { console.error(error); notify("Gagal melakukan generate data.", "error"); } finally { setIsGenerating(false); } };
          return ( <div className="space-y-6"> <div className="flex flex-col md:flex-row justify-between items-start md:items-center bg-white p-6 rounded-2xl shadow-sm border gap-4"> <div><h2 className="text-2xl font-bold text-gray-800">Selamat Datang di SI UJANG PRO</h2><p className="text-base text-gray-600 font-semibold">(Aplikasi Ujian Jujur Anti Curang)</p><p className="text-sm text-indigo-500 mt-1 font-medium">Solusi Digitalisasi Evaluasi Pembelajaran Berbasis Integritas</p></div> <button onClick={() => setShowConfigModal(true)} disabled={isGenerating} className={`${isGenerating ? 'bg-indigo-400 cursor-wait' : 'bg-indigo-600 hover:bg-indigo-700 active:scale-95'} text-white px-5 py-2.5 rounded-xl flex items-center gap-2 shadow-lg shadow-indigo-100 transition font-bold text-sm w-full md:w-auto justify-center`}>{isGenerating ? <Loader className="animate-spin" size={16}/> : <Settings size={16}/>} {isGenerating ? 'Memproses Data...' : 'Konfigurasi Simulasi'}</button> </div> <div className="bg-white p-6 rounded-2xl shadow-sm border border-indigo-100"><h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><Database size={18} className="text-indigo-600"/> Pusat Kendali Data (Otomatis)</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="flex flex-col items-center justify-center p-4 border-2 border-dashed border-emerald-200 bg-emerald-50 rounded-xl transition"><Cloud size={24} className="text-emerald-600 mb-2"/><span className="font-bold text-sm text-emerald-800">Cloud Sync Aktif</span><span className="text-[10px] text-emerald-600 text-center">Data tersimpan otomatis di server.<br/>Aman dari refresh/ganti perangkat.</span></div><button onClick={onFactoryReset} className="flex flex-col items-center justify-center p-4 border-2 border-dashed border-red-200 bg-red-50 hover:bg-red-100 rounded-xl transition group"><RotateCcw size={24} className="text-red-600 mb-2 group-hover:rotate-180 transition-transform"/><span className="font-bold text-sm text-red-800">Reset Pabrik</span><span className="text-[10px] text-red-600">Hapus semua data & mulai baru</span></button></div></div> {showConfigModal && (<div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white p-6 rounded-2xl w-full max-w-lg shadow-2xl border max-h-[90vh] overflow-y-auto"><div className="flex justify-between items-center mb-4 border-b pb-4"><h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><Settings size={20}/> Konfigurasi Simulasi</h3><button onClick={() => setShowConfigModal(false)} className="text-gray-400 hover:text-red-500"><X size={20}/></button></div><div className="space-y-4 mb-6"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Jumlah Peserta</label><input type="number" min="1" max="100" className="w-full p-3 border rounded-xl font-bold" value={simConfig.count} onChange={e => setSimConfig({...simConfig, count: e.target.value})}/><p className="text-xs text-gray-400 mt-1">Saran: Maksimal 100 agar browser tidak lambat.</p></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Prefix Nama Siswa</label><input className="w-full p-3 border rounded-xl" placeholder="Contoh: Siswa XII IPA" value={simConfig.prefixName} onChange={e => setSimConfig({...simConfig, prefixName: e.target.value})}/></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Mata Pelajaran</label><input className="w-full p-3 border rounded-xl" placeholder="Contoh: Matematika Wajib" value={simConfig.subjectName} onChange={e => setSimConfig({...simConfig, subjectName: e.target.value})}/></div></div><div className="flex gap-2"><button onClick={() => setShowConfigModal(false)} className="flex-1 py-3 border rounded-xl font-bold text-gray-600 hover:bg-gray-50">Batal</button><button onClick={handleGenerateClick} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg flex items-center justify-center gap-2"><Zap size={18}/> Mulai Generate</button></div></div></div>)} <div className="grid grid-cols-1 md:grid-cols-3 gap-6"> <div className="bg-blue-500 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden group"><div className="relative z-10"><p className="text-xs uppercase font-bold opacity-80 mb-1 tracking-wider">Total Siswa</p><h3 className="text-4xl font-bold">{users.filter(u => u.role==='student').length}</h3></div><Users size={80} className="absolute -right-4 -bottom-4 opacity-20 group-hover:scale-110 transition-transform" /></div> <div className="bg-emerald-500 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden group"><div className="relative z-10"><p className="text-xs uppercase font-bold opacity-80 mb-1 tracking-wider">Total Paket Soal</p><h3 className="text-4xl font-bold">{questionBanks.length}</h3></div><BookOpen size={80} className="absolute -right-4 -bottom-4 opacity-20 group-hover:scale-110 transition-transform" /></div> <div className="bg-orange-500 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden group"><div className="relative z-10"><p className="text-xs uppercase font-bold opacity-80 mb-1 tracking-wider">Ujian Terjadwal</p><h3 className="text-4xl font-bold">{schedules.length}</h3></div><Calendar size={80} className="absolute -right-4 -bottom-4 opacity-20 group-hover:scale-110 transition-transform" /></div> </div> </div> );
        }

        function AdminParticipantData({ users, setUsers, notify }) {
          const [name, setName] = useState('');
          const [nis, setNis] = useState(''); const [cls, setCls] = useState(''); const [showImportModal, setShowImportModal] = useState(false); const [importFile, setImportFile] = useState(null);
          const [isProcessing, setIsProcessing] = useState(false); const [deleteTarget, setDeleteTarget] = useState(null); const [showResetConfirm, setShowResetConfirm] = useState(false);
          const handleAdd = () => { if(!name || !nis || !cls) return notify("Lengkapi input!", "error"); if(users.some(u => u.username === nis)) return notify("NIS sudah digunakan!", "error"); setUsers([...users, { username: nis.trim(), password: Math.floor(100000 + Math.random() * 900000).toString(), role: "student", name, nis, class: cls }]); setName(''); setNis(''); setCls(''); notify("Siswa berhasil ditambahkan!"); };
          const handleDownloadTemplate = () => { if (!window.XLSX) return notify("Menyiapkan generator Excel, coba lagi sebentar...", "error"); const ws_data = [["NIS", "NAMA LENGKAP", "KELAS", "PASSWORD (OPSIONAL)"], ["1001", "Ahmad Siswa", "X-A", "12345"], ["1002", "Budi Pelajar", "X-B", ""]]; const ws = window.XLSX.utils.aoa_to_sheet(ws_data); const wb = window.XLSX.utils.book_new(); window.XLSX.utils.book_append_sheet(wb, ws, "Data Peserta"); window.XLSX.writeFile(wb, "Template_Siswa.xlsx"); };
          const handleReset = () => { setShowResetConfirm(true); };
          const confirmReset = () => { setUsers(users.filter(u => u.role !== 'student')); setShowResetConfirm(false); notify("Semua data siswa dihapus."); };
          const initiateDelete = (user) => { setDeleteTarget(user); };
          const confirmDelete = () => { if (deleteTarget) { setUsers(users.filter(u => u.username !== deleteTarget.username)); setDeleteTarget(null); notify("Siswa dihapus."); } };
          const handleImport = () => { 
              if(!importFile) return notify("Silakan pilih file Excel terlebih dahulu!", "error");
              if(!window.XLSX) return notify("Library Excel belum siap.", "error");
              setIsProcessing(true);
              const reader = new FileReader();
              reader.onload = (e) => {
                  try {
                      const data = new Uint8Array(e.target.result);
                      const workbook = window.XLSX.read(data, {type: 'array'}); const firstSheet = workbook.Sheets[workbook.SheetNames[0]]; const rows = window.XLSX.utils.sheet_to_json(firstSheet, {header: 1}); 
                      const newUsers = [];
                      let successCount = 0; let failCount = 0; 
                      for(let i=1; i<rows.length; i++) {
                          const row = rows[i];
                          if(row.length < 2) continue;
                          const nisVal = row[0] ? row[0].toString().trim() : ''; const nameVal = row[1] ? row[1].toString().trim() : '';
                          const classVal = row[2] ? row[2].toString().trim() : ''; const passVal = row[3] ? row[3].toString().trim() : '';
                          if(nisVal && nameVal && !users.some(u => u.username === nisVal) && !newUsers.some(u => u.username === nisVal)) { newUsers.push({ username: nisVal, password: passVal || Math.floor(100000 + Math.random() * 900000).toString(), role: "student", name: nameVal, nis: nisVal, class: classVal || 'UMUM' }); successCount++; } else { failCount++; } 
                      }
                      if(newUsers.length > 0) { setUsers([...users, ...newUsers]); setImportFile(null); setShowImportModal(false); notify(`Sukses import ${successCount} siswa. Gagal/Duplikat: ${failCount}.`); } else { notify("Tidak ada data valid yang bisa diimport.", "error"); } 
                  } catch(err) { console.error(err); notify("Gagal memproses file Excel.", "error");
                  } finally { setIsProcessing(false); }
              };
              reader.readAsArrayBuffer(importFile);
          };
          return (<div className="bg-white p-6 rounded-2xl border shadow-sm"><div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"><h3 className="font-bold text-lg text-gray-700">Manajemen Data Peserta</h3><div className="flex gap-2 w-full md:w-auto"><button onClick={handleReset} className="px-4 py-2 border border-red-200 text-red-500 rounded-xl font-bold text-xs hover:bg-red-50 flex items-center gap-2 transition"><RotateCcw size={14}/> Reset Data</button><button onClick={handleDownloadTemplate} className="px-4 py-2 bg-emerald-50 text-emerald-600 border border-emerald-200 rounded-xl font-bold text-xs hover:bg-emerald-100 flex items-center gap-2 transition"><FileSpreadsheet size={14}/> Template Excel</button><button onClick={() => setShowImportModal(true)} className="px-4 py-2 bg-indigo-600 text-white rounded-xl font-bold text-xs hover:bg-indigo-700 flex items-center gap-2 shadow-md transition"><FileUp size={14}/> Import Excel</button></div></div><div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 bg-gray-50 p-4 rounded-xl border border-gray-100"><input className="p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 text-sm bg-white" placeholder="Nama Lengkap" value={name} onChange={e=>setName(e.target.value)} /><input className="p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 text-sm bg-white" placeholder="NIS / Username" value={nis} onChange={e=>setNis(e.target.value)} /><input className="p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 text-sm bg-white" placeholder="Kelas" value={cls} onChange={e=>setCls(e.target.value)} /><button onClick={handleAdd} className="bg-indigo-600 text-white rounded-lg font-bold text-sm shadow-sm hover:bg-indigo-700 transition flex items-center justify-center gap-2"><Plus size={16}/> Tambah Manual</button></div><div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-gray-50 border-b"><tr><th className="p-4 font-bold text-gray-500 whitespace-nowrap">NIS</th><th className="p-4 font-bold text-gray-500 whitespace-nowrap">Nama</th><th className="p-4 font-bold text-gray-500 whitespace-nowrap">Kelas</th><th className="p-4 font-bold text-gray-500 whitespace-nowrap">Sandi</th><th className="p-4 text-center font-bold text-gray-500 whitespace-nowrap">Aksi</th></tr></thead><tbody className="divide-y">{users.filter(u=>u.role==='student').length === 0 ? (<tr><td colSpan="5" className="p-8 text-center text-gray-400">Belum ada data peserta. Silakan tambah atau import.</td></tr>) : (users.filter(u=>u.role==='student').map((u)=>(<tr key={u.username} className="hover:bg-gray-50 transition"><td className="p-4 text-gray-600 whitespace-nowrap">{u.nis}</td><td className="p-4 font-bold text-gray-800 whitespace-nowrap">{u.name}</td><td className="p-4 text-gray-600 whitespace-nowrap">{u.class}</td><td className="p-4 whitespace-nowrap"><span className="px-2 py-1 bg-indigo-50 text-indigo-700 rounded font-mono font-bold text-xs">{u.password}</span></td><td className="p-4 text-center whitespace-nowrap"><button onClick={()=>initiateDelete(u)} className="text-red-500 hover:bg-red-50 p-2 rounded-lg transition"><Trash2 size={16}/></button></td></tr>)))}</tbody></table></div>{showImportModal && (<div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white p-6 rounded-2xl w-[95%] md:w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto"><div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg">Import Data Siswa (Excel)</h3><button onClick={() => setShowImportModal(false)}><X className="text-gray-400 hover:text-red-500"/></button></div><div className="mb-6 space-y-4"><div className="bg-blue-50 p-4 rounded-xl text-blue-800 text-xs leading-relaxed border border-blue-100"><strong>Panduan Import:</strong><br/>1. Gunakan tombol "Template Excel" untuk mengunduh format.<br/>2. Isi data (NIS, Nama, Kelas) dan jangan ubah header.<br/>3. Upload file Excel yang sudah diisi di bawah ini.</div><div className="border-2 border-dashed border-gray-300 rounded-xl p-8 flex flex-col items-center justify-center text-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 transition relative"><FileSpreadsheet size={48} className="text-emerald-500 mb-2"/><p className="text-sm font-bold text-gray-600">{importFile ? importFile.name : "Klik untuk pilih file Excel"}</p><p className="text-xs text-gray-400 mt-1">Format: .xlsx / .xls</p><input type="file" accept=".xlsx, .xls" onChange={e => setImportFile(e.target.files[0])} className="absolute inset-0 opacity-0 cursor-pointer" /></div></div><div className="flex justify-end gap-2"><button onClick={() => setShowImportModal(false)} className="px-4 py-2 border rounded-xl font-bold text-sm">Batal</button><button onClick={handleImport} disabled={isProcessing} className="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 flex items-center gap-2">{isProcessing ? <Loader className="animate-spin" size={16}/> : <Upload size={16}/>} Proses Import</button></div></div></div>)}{deleteTarget && (<div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl border"><div className="flex flex-col items-center text-center"><div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-600"><AlertTriangle size={32}/></div><h3 className="text-lg font-bold mb-2">Hapus Siswa?</h3><p className="text-sm text-gray-500 mb-6">Anda akan menghapus data siswa <strong>{deleteTarget.name}</strong>. Tindakan ini tidak dapat dibatalkan.</p><div className="flex gap-3 w-full"><button onClick={() => setDeleteTarget(null)} className="flex-1 py-2 border rounded-xl font-bold text-sm hover:bg-gray-50">Batal</button><button onClick={confirmDelete} className="flex-1 py-2 bg-red-600 text-white rounded-xl font-bold text-sm hover:bg-red-700 shadow-md">Ya, Hapus</button></div></div></div></div>)}{showResetConfirm && (<div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl border border-red-100"><div className="flex flex-col items-center text-center"><div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-600"><AlertTriangle size={32}/></div><h3 className="text-lg font-bold mb-2 text-gray-900">Reset Data Peserta?</h3><p className="text-sm text-gray-500 mb-6 leading-relaxed">Anda akan menghapus <strong>SELURUH</strong> data siswa.<br/>Data Admin tidak akan terhapus. <br/><span className="text-red-500 font-bold">Tindakan ini tidak dapat dibatalkan!</span></p><div className="flex gap-3 w-full"><button onClick={() => setShowResetConfirm(false)} className="flex-1 py-3 border rounded-xl font-bold text-sm hover:bg-gray-50 transition">Batal</button><button onClick={confirmReset} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold text-sm hover:bg-red-700 shadow-md transition flex items-center justify-center gap-2"><Trash2 size={16}/> Hapus Semua</button></div></div></div></div>)}</div>);
        }

        function AdminSchoolProfile({ profile, setProfile, notify }) {
          const [formData, setFormData] = useState(profile);
          const [isSaved, setIsSaved] = useState(false);
          const handleSave = () => { setProfile(formData); setIsSaved(true); setTimeout(() => setIsSaved(false), 3000); notify("Profil sekolah tersimpan."); };
          const handleLogoUpload = (e) => { const file = e.target.files[0]; if (file) { if (file.size > 2000000) { notify("Ukuran file terlalu besar! Maksimal 2MB.", "error"); return; } const reader = new FileReader(); reader.onloadend = () => { setFormData({ ...formData, logoUrl: reader.result }); }; reader.readAsDataURL(file); } };
          return (<div className="space-y-6 animate-fade-in"><div className="flex justify-between items-center"><div><h2 className="text-2xl font-bold text-gray-800">Profil & Kop Sekolah</h2><p className="text-sm text-gray-500">Konfigurasi identitas untuk kartu dan laporan.</p></div><button onClick={handleSave} className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-xl shadow-lg flex items-center gap-2 transition font-bold">{isSaved ? <CheckCircle size={18} /> : <Save size={18} />} {isSaved ? 'Tersimpan' : 'Simpan Profil'}</button></div><div className="bg-white rounded-2xl shadow-sm border p-8 space-y-8"><div className="grid grid-cols-1 md:grid-cols-3 gap-8 pb-8 border-b border-dashed"><div className="md:col-span-1"><label className="block text-xs font-bold text-gray-400 uppercase mb-3">Logo Instansi</label><div className="w-full aspect-square border-2 border-dashed rounded-3xl flex items-center justify-center bg-gray-50 overflow-hidden group relative hover:border-indigo-400 hover:bg-indigo-50 transition cursor-pointer">{formData.logoUrl ? (<img src={formData.logoUrl} className="w-full h-full object-contain p-6" />) : (<div className="flex flex-col items-center text-gray-300 group-hover:text-indigo-400"><ImageIcon size={48} /><span className="text-[10px] font-bold mt-2 uppercase">Upload Logo</span></div>)}<div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition backdrop-blur-sm"><p className="text-white font-bold text-xs flex items-center gap-2"><Upload size={16}/> Ganti Logo</p></div><input type="file" accept="image/png, image/jpeg, image/jpg" onChange={handleLogoUpload} className="absolute inset-0 opacity-0 cursor-pointer" title="Klik untuk upload logo"/></div><p className="text-[10px] text-center mt-3 text-gray-400">Format: PNG/JPG (Max 2MB)</p></div><div className="md:col-span-2 space-y-4"><div><label className="block text-xs font-bold text-gray-400 uppercase mb-1">Nama Ujian / Kegiatan</label><input className="w-full p-3 border rounded-xl font-bold" value={formData.examName} onChange={e=>setFormData({...formData, examName: e.target.value})} /></div><div><label className="block text-xs font-bold text-gray-400 uppercase mb-1">Nama Instansi / Sekolah</label><input className="w-full p-3 border rounded-xl" value={formData.schoolName} onChange={e=>setFormData({...formData, schoolName: e.target.value})} /></div><div><label className="block text-xs font-bold text-gray-400 uppercase mb-1">Alamat Lengkap</label><textarea className="w-full p-3 border rounded-xl text-sm" value={formData.address} onChange={e=>setFormData({...formData, address: e.target.value})} rows="2" /></div></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label className="block text-xs font-bold text-gray-400 uppercase mb-1">Nama Kepala Sekolah</label><input className="w-full p-3 border rounded-xl" value={formData.headmaster} onChange={e=>setFormData({...formData, headmaster: e.target.value})} /></div><div><label className="block text-xs font-bold text-gray-400 uppercase mb-1">NIP Kepala Sekolah</label><input className="w-full p-3 border rounded-xl font-mono" value={formData.nip} onChange={e=>setFormData({...formData, nip: e.target.value})} /></div></div></div></div>);
        }

        function AdminBankSoal({ questionBanks, setQuestionBanks, notify }) {
          const [wordFile, setWordFile] = useState(null);
          const [keyFile, setKeyFile] = useState(null);
          const [importBankName, setImportBankName] = useState(''); 
          const [importBankCode, setImportBankCode] = useState(''); 
          const [importStep, setImportStep] = useState('upload');
          const [previewData, setPreviewData] = useState([]);
          const [isProcessing, setIsProcessing] = useState(false); 
          const [isDetailView, setIsDetailView] = useState(false); 
          const [activeDetailBank, setActiveDetailBank] = useState(null);
          const [deleteTarget, setDeleteTarget] = useState(null);
          
          const handleDownloadTemplateWord = () => {
            const docContent = `
              <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Template Soal Si Ujang</title><style>body{font-family:Arial,sans-serif;font-size:11pt;line-height:1.5}table{width:100%;border-collapse:collapse;margin-bottom:20px}td{border:1px solid #000;padding:8px;vertical-align:top}.header{background:#e0e0e0;font-weight:bold;text-align:center}.instruction{background:#e3f2fd;border:1px solid #2196f3;color:#0d47a1;padding:15px;border-radius:5px;margin-bottom:20px}.section-title{background:#333;color:#fff;padding:5px 10px;font-weight:bold;margin-top:30px}</style></head><body><h2>TEMPLATE BANK SOAL SI UJANG</h2><div class="instruction"><strong>PANDUAN MENAMBAH SOAL:</strong><ol><li>Setiap soal <strong>WAJIB</strong> berada di dalam 1 tabel tersendiri.</li><li>Untuk menambah soal baru: <strong>Blok seluruh tabel contoh -> Copy -> Paste di bawahnya</strong>.</li><li>Ganti Nomor Soal (1, 2, 3, dst) dan isi pertanyaannya.</li><li>Gambar bisa langsung di-paste (Insert Image) ke dalam kolom KONTEN.</li></ol></div><div class="section-title">TIPE 1: PILIHAN GANDA (PG)</div><p><em>Gunakan format ini untuk soal dengan 1 jawaban benar.</em></p><table><tr class="header"><td width="80">NO / OPSI</td><td>KONTEN SOAL</td></tr><tr><td align="center"><strong>1</strong></td><td>Tuliskan Pertanyaan Pilihan Ganda di sini...</td></tr><tr><td align="center">A</td><td>Pilihan A</td></tr><tr><td align="center">B</td><td>Pilihan B</td></tr><tr><td align="center">C</td><td>Pilihan C</td></tr><tr><td align="center">D</td><td>Pilihan D</td></tr><tr><td align="center">E</td><td>Pilihan E</td></tr></table><br/><div class="section-title">TIPE 2: PILIHAN GANDA MAJEMUK (PGM)</div><p><em>Gunakan format ini untuk soal dengan LEBIH DARI 1 jawaban benar.</em></p><table><tr class="header"><td width="80">NO / OPSI</td><td>KONTEN SOAL</td></tr><tr><td align="center"><strong>2</strong></td><td>Tuliskan Pertanyaan Pilihan Ganda Majemuk di sini... (Pilihlah pernyataan-pernyataan yang benar!)</td></tr><tr><td align="center">A</td><td>Opsi 1</td></tr><tr><td align="center">B</td><td>Opsi 2</td></tr><tr><td align="center">C</td><td>Opsi 3</td></tr><tr><td align="center">D</td><td>Opsi 4</td></tr><tr><td align="center">E</td><td>Opsi 5</td></tr></table><br/><div class="section-title">TIPE 3: BENAR / SALAH (BS)</div><p><em>Gunakan format ini untuk soal pernyataan Benar atau Salah. Maksimal 5 pernyataan (A-E).</em></p><table><tr class="header"><td width="80">NO / OPSI</td><td>KONTEN SOAL</td></tr><tr><td align="center"><strong>3</strong></td><td>Perhatikan pernyataan berikut! Tentukan Benar atau Salah.</td></tr><tr><td align="center">A</td><td>Pernyataan 1</td></tr><tr><td align="center">B</td><td>Pernyataan 2</td></tr><tr><td align="center">C</td><td>Pernyataan 3</td></tr><tr><td align="center">D</td><td>Pernyataan 4</td></tr><tr><td align="center">E</td><td>Pernyataan 5</td></tr></table><br/><hr/><p style="text-align:center; color:#666;"><em>-- Akhir Dokumen --</em></p></body></html>
            `;
            const blob = new Blob(['\ufeff', docContent], { type: 'application/msword' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Template_Soal_SiUjang_V3.doc"; link.click();
          };

          const handleDownloadTemplateExcel = () => { 
              if (!window.XLSX) return notify("Menyiapkan generator Excel...", "error");
              const ws_data = [["NO", "TIPE", "KUNCI"], ["1", "PG", "A"], ["2", "PGM", "A,C,E"], ["3", "BS", "B,S,B,B,S"], ["4", "PG", "C"], ["5", "PG", "D"]];
              const ws = window.XLSX.utils.aoa_to_sheet(ws_data); const wb = window.XLSX.utils.book_new(); window.XLSX.utils.book_append_sheet(wb, ws, "Kunci Jawaban"); window.XLSX.writeFile(wb, "Template_Kunci.xlsx"); 
          };
          const clean = (str) => str ? str.replace(/[\u00A0\s]+/g, ' ').trim() : '';
          
          const handleSmartImport = async () => {
              if(!wordFile || !keyFile || !importBankName || !importBankCode) return notify("Lengkapi semua data dan file!", "error");
              if (!window.XLSX || !window.mammoth) return notify("Library belum siap, tunggu sebentar.", "error");
              setIsProcessing(true);
              
              const readExcel = (file) => { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = window.XLSX.read(data, {type: 'array'}); const firstSheet = workbook.Sheets[workbook.SheetNames[0]]; const jsonData = window.XLSX.utils.sheet_to_json(firstSheet, {header: 1}); resolve(jsonData); } catch (err) { reject(err); } }; reader.readAsArrayBuffer(file); }); };
              
              try {
                const keyData = await readExcel(keyFile);
                const keyMap = {};
                keyData.slice(1).forEach(row => { 
                    if (row[0] && row[2]) { 
                        const no = row[0].toString().trim(); 
                        const typeCode = (row[1] || 'PG').toString().toUpperCase().trim(); 
                        const rawKey = row[2].toString().trim(); 
                        let type = 'single'; 
                        if(typeCode === 'PGM') type = 'complex'; 
                        if(typeCode === 'BS') type = 'truefalse'; 
                        
                        let correctAns = []; 
                        if(type === 'single') { 
                            const code = rawKey.charCodeAt(0); 
                            if(code >= 65) correctAns = [code - 65]; 
                        } else { 
                            correctAns = rawKey.split(/[;,]/).map(k => { 
                                const kTrim = k.trim().toUpperCase(); 
                                if (type === 'truefalse') return kTrim; 
                                const code = kTrim.charCodeAt(0); 
                                return (code >= 65) ? code - 65 : null; 
                            }).filter(x => x !== null); 
                        } 
                        keyMap[no] = { type, correctAnswer: correctAns }; 
                    } 
                });

                const readerWord = new FileReader();
                readerWord.onload = function(eWord) { 
                    const buffer = eWord.target.result;
                    const options = { convertImage: window.mammoth.images.imgElement(function(image) { return image.read("base64").then(function(imageBuffer) { return { src: "data:" + image.contentType + ";base64," + imageBuffer }; }); }) };
                    window.mammoth.convertToHtml({arrayBuffer: buffer}, options).then(result => processHTML(result.value, keyMap)).catch(err => { processFallback(buffer, keyMap); }); 
                }; 
                readerWord.readAsArrayBuffer(wordFile);
              } catch (err) { notify("Gagal import: " + err.message, "error"); setIsProcessing(false); }
          };

          const processHTML = (html, keyMap) => { 
              const parser = new DOMParser(); 
              const doc = parser.parseFromString(html, 'text/html');
              const questions = []; 
              const tables = doc.querySelectorAll('table'); 
              
              tables.forEach(table => { 
                  const rows = Array.from(table.querySelectorAll('tr')); 
                  if (rows.length < 2) return; 
                  let currentQ = null; 
                  
                  rows.forEach(row => { 
                      const cells = row.querySelectorAll('td'); 
                      if (cells.length < 2) return; 
                      
                      const col1 = clean(cells[0].textContent); 
                      const col2Html = cells[1].innerHTML; 
                      
                      if (/^\d+$/.test(col1)) { 
                          if (currentQ) questions.push(currentQ); 
                          const qNo = col1; 
                          const keyData = keyMap[qNo] || { type: 'single', correctAnswer: [] }; 
                          currentQ = { id: parseInt(qNo), question: col2Html, options: [], correctAnswer: keyData.correctAnswer, type: keyData.type, questionImages: [], optionImages: [[],[],[],[],[]] }; 
                      } 
                      else if (/^[A-E][.\s)]*$/i.test(col1) && currentQ) { 
                          const optIdx = col1.toUpperCase().charCodeAt(0) - 65; 
                          if (optIdx >= 0 && optIdx < 5) { 
                              currentQ.options[optIdx] = col2Html; 
                          } 
                      } 
                  }); 
                  if (currentQ) questions.push(currentQ); 
              });
              
              if (questions.length === 0) { notify("Format tabel tidak dikenali.", "error"); setIsProcessing(false); return; } 
              setPreviewData(questions); 
              setImportStep('preview'); 
              setIsProcessing(false); 
          };

          const processFallback = (buffer, keyMap) => { try { const dec = new TextDecoder("utf-8"); const txt = dec.decode(buffer); processHTML(txt, keyMap); } catch (e) { notify("Gagal membaca file.", "error"); setIsProcessing(false); } };
          
          const commitImport = async () => { 
              const newBank = { id: 'bank_' + Date.now(), code: importBankCode, subject: importBankName, date: new Date().toLocaleDateString('id-ID'), questions: previewData };
              setQuestionBanks(prev => [...prev, newBank]); 
              setImportStep('upload'); 
              
              if (db) {
                  try {
                      const bankDocRef = doc(db, 'siujang_banks', newBank.id);
                      await setDoc(bankDocRef, newBank);
                  } catch (error) {
                      console.error("Gagal simpan bank soal ke server", error);
                  }
              }
              notify("Bank soal berhasil disimpan!"); 
          };

          const handleDelete = () => { if (deleteTarget) { setQuestionBanks(prev => prev.filter(b => b.id !== deleteTarget.id)); setDeleteTarget(null); notify("Bank soal dihapus."); } };
          
          if (isDetailView && activeDetailBank) { 
              return (
                  <div className="space-y-6 animate-fade-in text-gray-800">
                      <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                          <div className="flex items-center gap-4">
                              <button onClick={() => setIsDetailView(false)} className="p-2 hover:bg-gray-100 rounded-lg text-gray-600 transition"><ArrowLeft size={20} /></button>
                              <div><h2 className="text-xl font-bold">{activeDetailBank.subject}</h2><p className="text-sm text-gray-500 font-mono tracking-wider">{activeDetailBank.code}</p></div>
                          </div>
                          <span className="bg-emerald-100 text-emerald-700 px-3 py-2 rounded-full text-xs font-bold border border-emerald-200">{activeDetailBank.questions.length} Butir</span>
                      </div>
                      <div className="grid gap-4">
                          {activeDetailBank.questions.map((q, idx) => (
                              <div key={idx} className="bg-white p-6 rounded-xl border border-gray-200 hover:shadow-md transition relative group">
                                  <div className="flex gap-4">
                                      <span className="w-8 h-8 flex items-center justify-center rounded-lg bg-indigo-600 text-white font-bold text-sm flex-shrink-0">{idx + 1}</span>
                                      <div className="flex-1 overflow-hidden">
                                          <span className={`text-[10px] font-bold uppercase mb-2 inline-block px-2 py-0.5 rounded ${q.type === 'complex' ? 'bg-purple-100 text-purple-700' : q.type === 'truefalse' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>{q.type === 'complex' ? 'Majemuk' : q.type === 'truefalse' ? 'Benar/Salah' : 'Pilihan Ganda'}</span>
                                          <div className="font-semibold text-gray-800 text-base mb-3 leading-relaxed prose prose-sm max-w-none [&_img]:max-w-full [&_img]:h-auto [&_img]:rounded-lg [&_img]:my-2" dangerouslySetInnerHTML={{ __html: q.question }} />
                                          <div className="grid gap-2 pl-4 border-l-2 border-gray-100">
                                              {q.options.map((opt, i) => {
                                                  const isTF = q.type === 'truefalse';
                                                  const keyVal = isTF && q.correctAnswer ? q.correctAnswer[i] : null;
                                                  return (
                                                      <div key={i} className="text-sm text-gray-600 flex items-start gap-2 group/opt">
                                                          <span className="font-bold w-12 pt-0.5 flex-shrink-0 flex items-center gap-1">
                                                              {String.fromCharCode(65+i)}. 
                                                              {isTF && keyVal && <span className={`text-[10px] px-1.5 py-0.5 rounded text-white ${keyVal==='B'?'bg-blue-500':'bg-red-500'}`}>{keyVal}</span>}
                                                          </span>
                                                          <div className="flex-1 prose prose-sm max-w-none [&_img]:max-w-[150px] [&_img]:rounded" dangerouslySetInnerHTML={{ __html: opt }} />
                                                      </div>
                                                  )
                                              })}
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          ))}
                      </div>
                  </div>
              ); 
          }
          if (importStep === 'preview') { 
              return (
                  <div className="space-y-6 animate-fade-in">
                      <div className="bg-white p-6 rounded-2xl border shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
                          <div><h3 className="font-bold text-lg text-indigo-900">🔍 Pratinjau Soal ({previewData.length} Soal)</h3></div>
                          <div className="flex gap-2">
                              <button onClick={() => setImportStep('upload')} className="px-5 py-2.5 border rounded-xl font-bold text-gray-500 hover:bg-gray-50 text-sm">Batal</button>
                              <button onClick={commitImport} className="px-5 py-2.5 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 shadow-lg text-sm flex items-center gap-2"><CheckCircle size={16}/> Simpan ke Bank Soal</button>
                          </div>
                      </div>
                      <div className="grid gap-4">
                          {previewData.map((q, idx) => (
                              <div key={idx} className="bg-white p-5 rounded-xl border border-gray-200">
                                  <div className="flex gap-4">
                                      <div className="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 font-bold flex items-center justify-center text-sm">{idx+1}</div>
                                      <div className="flex-1">
                                          <div className="text-sm font-semibold mb-2 prose prose-sm max-w-none" dangerouslySetInnerHTML={{__html: q.question}} />
                                          <div className="grid grid-cols-1 gap-1">
                                              {q.options.map((opt, i) => {
                                                  const isTF = q.type === 'truefalse';
                                                  const tfKey = isTF && q.correctAnswer ? q.correctAnswer[i] : null;
                                                  let isCorrectClass = 'bg-gray-50 border-gray-100 text-gray-500';
                                                  
                                                  if (isTF) {
                                                      if (tfKey === 'B') isCorrectClass = 'bg-blue-50 border-blue-200 text-blue-700 font-bold';
                                                      else if (tfKey === 'S') isCorrectClass = 'bg-red-50 border-red-200 text-red-700 font-bold';
                                                  } else {
                                                      if (q.correctAnswer.includes(i) || q.correctAnswer.includes(String.fromCharCode(65+i))) {
                                                          isCorrectClass = 'bg-green-50 border-green-200 text-green-700 font-bold';
                                                      }
                                                  }
                                                  return (
                                                      <div key={i} className={`text-xs px-3 py-2 rounded border flex items-start gap-2 ${isCorrectClass}`}>
                                                          <span className="flex items-center gap-1 font-bold">
                                                              {String.fromCharCode(65+i)}.
                                                              {isTF && tfKey && <span className={`text-[9px] px-1 rounded text-white ${tfKey==='B'?'bg-blue-500':'bg-red-500'}`}>{tfKey}</span>}
                                                          </span>
                                                          <div className="prose prose-sm max-w-none" dangerouslySetInnerHTML={{ __html: opt }} />
                                                      </div>
                                                  )
                                              })}
                                          </div>
                                      </div>
                                  </div>
                              </div>
                          ))}
                      </div>
                  </div>
              ) 
          }
          return ( <div className="space-y-6 animate-fade-in"> <div className="bg-white p-6 rounded-2xl border shadow-sm space-y-4"> <div className="flex items-center justify-between border-b pb-2"><h3 className="font-bold text-gray-700">Bank Soal (Dual-File Import)</h3><div className="flex gap-2"><button onClick={handleDownloadTemplateWord} className="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg font-bold">Template Soal</button><button onClick={handleDownloadTemplateExcel} className="text-xs bg-emerald-50 text-emerald-600 px-3 py-1.5 rounded-lg font-bold">Template Kunci</button></div></div> <div className="bg-indigo-50 p-8 rounded-xl border border-indigo-100 flex flex-col items-center text-center"><div className="w-full max-w-lg space-y-4 bg-white p-6 rounded-2xl shadow-sm border"><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input className="w-full p-3 rounded-xl border" placeholder="Mapel" value={importBankName} onChange={e => setImportBankName(e.target.value)} /><input className="w-full p-3 rounded-xl border" placeholder="Kode" value={importBankCode} onChange={e => setImportBankCode(e.target.value)} /></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div className="relative border-2 border-dashed border-blue-300 p-4 flex flex-col items-center gap-2 cursor-pointer"><FileText className="text-blue-500" size={32}/><span className="text-xs">{wordFile ? wordFile.name : '1. File Soal'}</span><input type="file" onChange={e=>setWordFile(e.target.files[0])} className="absolute inset-0 opacity-0 cursor-pointer"/></div><div className="relative border-2 border-dashed border-emerald-300 p-4 flex flex-col items-center gap-2 cursor-pointer"><FileSpreadsheet className="text-emerald-500" size={32}/><span className="text-xs">{keyFile ? keyFile.name : '2. File Kunci'}</span><input type="file" onChange={e=>setKeyFile(e.target.files[0])} className="absolute inset-0 opacity-0 cursor-pointer"/></div></div><button onClick={handleSmartImport} disabled={isProcessing} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">Proses Import</button></div></div> </div> <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{questionBanks.map(bank => (<div key={bank.id} className="bg-white p-5 rounded-2xl border border-gray-200 relative group overflow-hidden"><div className="relative z-10"><h4 className="font-bold text-gray-800 text-lg">{bank.subject}</h4><div className="flex items-center justify-between border-t pt-3"><span className="text-xs font-bold text-emerald-600">{bank.questions.length} Soal</span><div className="flex gap-2"><button onClick={() => { setActiveDetailBank(bank); setIsDetailView(true); }} className="p-1.5 text-indigo-600"><Eye size={18}/></button><button onClick={() => setDeleteTarget(bank)} className="p-1.5 text-red-500 hover:bg-red-50 rounded-lg transition"><Trash2 size={18}/></button></div></div></div></div>))}</div> {deleteTarget && (<div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl border"><div className="flex flex-col items-center text-center"><div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-600"><AlertTriangle size={32}/></div><h3 className="text-lg font-bold mb-2">Hapus Bank Soal?</h3><p className="text-sm text-gray-500 mb-6">Anda akan menghapus paket <strong>{deleteTarget.subject}</strong>. Tindakan ini tidak dapat dibatalkan.</p><div className="flex gap-3 w-full"><button onClick={() => setDeleteTarget(null)} className="flex-1 py-2 border rounded-xl font-bold text-sm hover:bg-gray-50">Batal</button><button onClick={handleDelete} className="flex-1 py-2 bg-red-600 text-white rounded-xl font-bold text-sm hover:bg-red-700 shadow-md">Ya, Hapus</button></div></div></div></div>)} </div> );
        }

        function AdminResults({ results, setResults, schedules, questionBanks, users, notify }) {
          const [analyzingResult, setAnalyzingResult] = useState(null);
          const [deleteResultTarget, setDeleteResultTarget] = useState(null);
          const [showMassDeleteConfirm, setShowMassDeleteConfirm] = useState(false);
          const [filterClass, setFilterClass] = useState('Semua Kelas');
          const [filterSchedule, setFilterSchedule] = useState('Semua Jadwal');
          
          const [showPendingModal, setShowPendingModal] = useState(false);
          
          const classes = ['Semua Kelas', ...new Set(users.filter(u => u.role === 'student').map(u => u.class))].sort();
          
          const getAnalysisData = (result) => {
              const schedule = schedules.find(s => s.id === result.scheduleId);
              if (!schedule) return null;
              const bank = questionBanks.find(b => b.id === schedule.bankId); if (!bank) return null;
              return bank.questions.map(q => {
                  const userAns = result.answers[q.id]; const correctAns = q.correctAnswer;
                  let isCorrect = false; let userAnsLabel = '-'; let keyLabel = '-';
                  const formatAns = (ansArr) => { if(!ansArr) return '-'; if(q.type === 'truefalse') return ansArr.join(', '); return ansArr.map(idx => String.fromCharCode(65+idx)).join(', '); };
                  if (q.type === 'truefalse') {
                      isCorrect = JSON.stringify(userAns) === JSON.stringify(correctAns);
                  } else {
                       const u = [...(userAns||[])].sort(); 
                       const c = [...(correctAns||[])].sort(); 
                       isCorrect = JSON.stringify(u) === JSON.stringify(c);
                  }
                  userAnsLabel = q.type === 'truefalse' ? (userAns ? userAns.join(', ') : '-') : formatAns(userAns); 
                  keyLabel = q.type === 'truefalse' ? correctAns.join(', ') : formatAns(correctAns);
                  return { no: q.id, questionSnippet: q.question.replace(/<[^>]+>/g, '').substring(0, 50) + '...', type: q.type, userAnsLabel, keyLabel, isCorrect };
              });
          };
          
          const filteredResults = results.filter(r => { const student = users.find(u => u.name === r.studentName); const matchClass = filterClass === 'Semua Kelas' || (student && student.class === filterClass); const matchSched = filterSchedule === 'Semua Jadwal' || r.scheduleId == filterSchedule; return matchClass && matchSched; });
          
          const stats = React.useMemo(() => {
            if (filteredResults.length === 0) return { avg: 0, max: 0, min: 0, pass: 0, fail: 0 };
            const scores = filteredResults.map(r => r.score); const total = scores.reduce((a, b) => a + b, 0);
            return { avg: (total / scores.length).toFixed(1), max: Math.max(...scores), min: Math.min(...scores), pass: scores.filter(s => s >= 70).length, fail: scores.filter(s => s < 70).length };
          }, [filteredResults]);
          
          let pendingStudents = [];
          let selectedScheduleObj = null;
          if (filterSchedule !== 'Semua Jadwal') {
              selectedScheduleObj = schedules.find(s => s.id == filterSchedule);
              if (selectedScheduleObj) {
                  const completedNames = results.filter(r => r.scheduleId == filterSchedule).map(r => r.studentName);
                  pendingStudents = users.filter(u => {
                      if (u.role !== 'student') return false;
                      const matchScheduleClass = selectedScheduleObj.classes.includes('Semua Kelas') || selectedScheduleObj.classes.includes(u.class);
                      const matchFilterClass = filterClass === 'Semua Kelas' || u.class === filterClass;
                      return matchScheduleClass && matchFilterClass && !completedNames.includes(u.name);
                  });
              }
          }

          const handleDownloadExcel = () => {
            if (!window.XLSX) return notify("Engine Excel sedang dimuat, coba 2 detik lagi...", "error");
            if (filteredResults.length === 0) return notify("Tidak ada data untuk diunduh!", "error");
            const excelData = filteredResults.map((r, index) => { 
                const student = users.find(u => u.name === r.studentName); 
                const schedule = schedules.find(s => s.id === r.scheduleId); 
                return { 
                    "No": index + 1, 
                    "Nama Siswa": r.studentName, 
                    "NIS": student?.nis || "-", 
                    "Kelas": student?.class || "-", 
                    "Mata Pelajaran": r.bankName || schedule?.bankName || "-", 
                    "Sesi Ujian": r.scheduleName || schedule?.name || "-", 
                    "Skor": r.score, 
                    "Jml Pelanggaran": r.cheatCount || 0,
                    "Detail Pelanggaran": (r.cheatLogs && r.cheatLogs.length > 0) ? r.cheatLogs.join(" | ") : "Aman",
                    "Waktu Selesai": r.date 
                }; 
            });
            const worksheet = window.XLSX.utils.json_to_sheet(excelData); const workbook = window.XLSX.utils.book_new(); window.XLSX.utils.book_append_sheet(workbook, worksheet, "Hasil Ujian"); const fileName = `REKAP_HASIL_${filterClass.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`; window.XLSX.writeFile(workbook, fileName);
          };

          // FUNGSI BARU: UNDUH EXCEL SISWA BELUM UJIAN
          const handleDownloadPendingExcel = () => {
              if (!window.XLSX) return notify("Engine Excel sedang dimuat, tunggu sebentar...", "error");
              if (pendingStudents.length === 0) return notify("Tidak ada data siswa untuk diunduh!", "error");
              
              const excelData = pendingStudents.map((stud, index) => ({
                  "No": index + 1,
                  "NIS / Username": stud.nis || stud.username,
                  "Nama Lengkap": stud.name,
                  "Kelas": stud.class,
                  "Status": "Belum Mengerjakan"
              }));

              const worksheet = window.XLSX.utils.json_to_sheet(excelData); 
              const workbook = window.XLSX.utils.book_new(); 
              window.XLSX.utils.book_append_sheet(workbook, worksheet, "Data Belum Ujian"); 
              
              const safeScheduleName = selectedScheduleObj ? selectedScheduleObj.name.replace(/[^a-zA-Z0-9]/g, '_') : 'Jadwal';
              const fileName = `BELUM_UJIAN_${safeScheduleName}_${new Date().toISOString().split('T')[0]}.xlsx`; 
              window.XLSX.writeFile(workbook, fileName);
          };

          const confirmDeleteResult = async () => {
              if (deleteResultTarget) {
                  try {
                      if (deleteResultTarget.docId) {
                          await deleteDoc(doc(db, 'siujang_results', deleteResultTarget.docId));
                      }
                      const newResults = results.filter(r => !(r.studentName === deleteResultTarget.studentName && r.scheduleId === deleteResultTarget.scheduleId));
                      setResults(newResults);
                      setDeleteResultTarget(null);
                      notify("Hasil dihapus! Siswa sekarang dapat mengulang ujian ini.", "success");
                  } catch (e) {
                      console.error(e);
                      notify("Terjadi kesalahan saat menghapus data.", "error");
                  }
              }
          };

          const handleMassDelete = async () => {
              try {
                  const deletePromises = filteredResults.map(r => {
                      if (r.docId) {
                          return deleteDoc(doc(db, 'siujang_results', r.docId));
                      }
                      return Promise.resolve();
                  });
                  await Promise.all(deletePromises);
                  const remainingResults = results.filter(r => !filteredResults.includes(r));
                  setResults(remainingResults);
                  setShowMassDeleteConfirm(false);
                  notify(`Berhasil menghapus ${filteredResults.length} data hasil ujian!`, "success");
              } catch(e) {
                  console.error(e);
                  notify("Terjadi kesalahan saat menghapus data massal.", "error");
              }
          };

          return (
            <div className="space-y-6 animate-fade-in">
               <div className="bg-white p-6 rounded-2xl border shadow-sm space-y-4">
                  <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                      <div>
                          <h3 className="font-bold text-xl text-gray-800">Hasil Ujian Siswa</h3>
                          <p className="text-sm text-gray-500">Rekapitulasi nilai dan analisis jawaban.</p>
                      </div>
                      <div className="flex gap-2 flex-wrap w-full md:w-auto">
                          <button onClick={() => setShowPendingModal(true)} className="bg-orange-50 text-orange-600 border border-orange-200 px-4 py-2.5 rounded-xl font-bold hover:bg-orange-100 transition flex items-center justify-center gap-2 text-sm shadow-sm w-full md:w-auto">
                              <Users size={16}/> Cek Belum Ujian
                          </button>
                          {filteredResults.length > 0 && (
                              <button onClick={() => setShowMassDeleteConfirm(true)} className="bg-red-50 text-red-600 border border-red-200 px-4 py-2.5 rounded-xl font-bold hover:bg-red-100 transition flex items-center justify-center gap-2 text-sm shadow-sm w-full md:w-auto">
                                  <Trash2 size={16}/> Hapus Data Filter
                              </button>
                          )}
                          <button onClick={handleDownloadExcel} className="bg-emerald-600 text-white px-6 py-2.5 rounded-xl font-bold shadow-lg shadow-emerald-100 hover:bg-emerald-700 transition flex items-center justify-center gap-2 text-sm w-full md:w-auto">
                              <FileDown size={18}/> Unduh Excel
                          </button>
                      </div>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-50"><div className="space-y-1"><label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">Filter Mapel/Jadwal</label><select value={filterSchedule} onChange={e => setFilterSchedule(e.target.value)} className="w-full p-2.5 bg-gray-50 border rounded-xl text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500"><option value="Semua Jadwal">Semua Jadwal / Mapel</option>{schedules.map(s => <option key={s.id} value={s.id}>{s.name} ({s.bankName})</option>)}</select></div><div className="space-y-1"><label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest ml-1">Filter Kelas</label><select value={filterClass} onChange={e => setFilterClass(e.target.value)} className="w-full p-2.5 bg-gray-50 border rounded-xl text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500">{classes.map(c => <option key={c} value={c}>{c}</option>)}</select></div></div>
                  {filteredResults.length > 0 && (<div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-6 border-t border-dashed border-gray-200 mt-2"><div className="p-4 bg-blue-50 rounded-2xl border border-blue-100 flex flex-col items-center justify-center text-center"><span className="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-1">Rata-rata Nilai</span><span className="text-3xl font-black text-blue-600">{stats.avg}</span></div><div className="p-4 bg-emerald-50 rounded-2xl border border-emerald-100 flex flex-col items-center justify-center text-center"><span className="text-[10px] font-bold text-emerald-400 uppercase tracking-widest mb-1">Nilai Tertinggi</span><span className="text-3xl font-black text-emerald-600">{stats.max}</span></div><div className="p-4 bg-red-50 rounded-2xl border border-red-100 flex flex-col items-center justify-center text-center"><span className="text-[10px] font-bold text-red-400 uppercase tracking-widest mb-1">Nilai Terendah</span><span className="text-3xl font-black text-red-600">{stats.min}</span></div><div className="p-4 bg-indigo-50 rounded-2xl border border-indigo-100 flex flex-col items-center justify-center text-center"><span className="text-[10px] font-bold text-indigo-400 uppercase tracking-widest mb-1">Lulus / Remidi</span><div className="flex items-baseline gap-2"><span className="text-3xl font-black text-indigo-600">{stats.pass}</span><span className="text-sm font-bold text-indigo-300">/ {stats.fail}</span></div></div></div>)}
               </div>
               <div className="bg-white rounded-2xl border shadow-sm overflow-hidden"><div className="overflow-x-auto"><table className="w-full text-left text-sm"><thead className="bg-gray-50 border-b"><tr><th className="p-4 font-bold text-gray-600 whitespace-nowrap">Nama Siswa</th><th className="p-4 font-bold text-gray-600 whitespace-nowrap">Kelas</th><th className="p-4 font-bold text-gray-600 whitespace-nowrap">Jadwal / Mapel</th><th className="p-4 font-bold text-gray-600 whitespace-nowrap text-center">Nilai</th><th className="p-4 font-bold text-gray-600 whitespace-nowrap text-center">Pelanggaran</th><th className="p-4 font-bold text-gray-600 text-center whitespace-nowrap">Aksi</th></tr></thead><tbody>{filteredResults.length === 0 ? (<tr><td colSpan="6" className="p-8 text-center text-gray-400 italic">Tidak ada data hasil yang sesuai filter.</td></tr>) : filteredResults.map((r, i) => { 
                   const student = users.find(u => u.name === r.studentName); 
                   const schedule = schedules.find(s => s.id === r.scheduleId); 
                   return (<tr key={i} className="border-b last:border-0 hover:bg-gray-50 transition">
                       <td className="p-4 font-bold text-gray-800 whitespace-nowrap">{r.studentName}</td>
                       <td className="p-4 text-gray-500 whitespace-nowrap">{student?.class || '-'}</td>
                       <td className="p-4 text-gray-500 whitespace-nowrap"><p className="font-semibold text-gray-700">{r.scheduleName || schedule?.name || 'Jadwal Terhapus'}</p><p className="text-[10px] text-gray-400 uppercase">{r.bankName || schedule?.bankName || 'Mapel Tidak Diketahui'}</p></td>
                       <td className="p-4 whitespace-nowrap text-center"><span className={`font-bold px-3 py-1 rounded-lg ${r.score >= 70 ? 'bg-emerald-50 text-emerald-600' : 'bg-red-50 text-red-600'}`}>{r.score}</span></td>
                       
                       <td className="p-4 whitespace-nowrap text-center relative group">
                           <span title={(r.cheatLogs || []).join('\n')} className={`font-bold px-3 py-1 rounded-lg text-xs border ${r.cheatCount > 0 ? 'bg-red-50 text-red-600 border-red-200 cursor-help' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                               {r.cheatCount || 0} Kali
                           </span>
                       </td>
                       
                       <td className="p-4 text-center whitespace-nowrap">
                           <div className="flex justify-center items-center gap-2">
                               <button onClick={() => setAnalyzingResult({ ...r, analysis: getAnalysisData(r) })} className="bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-100 transition border border-indigo-200">Analisis</button>
                               <button onClick={() => setDeleteResultTarget(r)} className="bg-red-50 text-red-500 p-1.5 rounded-lg hover:bg-red-100 transition border border-red-200" title="Hapus Hasil & Izinkan Ujian Ulang"><Trash2 size={16}/></button>
                           </div>
                       </td>
                   </tr>) })}</tbody></table></div></div>
               
               {analyzingResult && (<div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white rounded-2xl w-[95%] md:w-full max-w-3xl shadow-2xl border overflow-hidden flex flex-col max-h-[90vh]"><div className="p-5 border-b flex justify-between items-center bg-gray-50"><div><h3 className="font-bold text-lg text-gray-800">Analisis Jawaban</h3><p className="text-xs text-gray-500">Siswa: <b>{analyzingResult.studentName}</b> | Nilai: <b>{analyzingResult.score}</b></p></div><button onClick={() => setAnalyzingResult(null)}><X size={20} className="text-gray-400 hover:text-red-500"/></button></div><div className="p-0 overflow-y-auto flex-1">{!analyzingResult.analysis ? (<div className="p-8 text-center text-red-400">Data paket soal tidak ditemukan.</div>) : (<table className="w-full text-sm text-left"><thead className="bg-gray-100 text-gray-600 sticky top-0"><tr><th className="p-3 font-bold text-center border-b">No</th><th className="p-3 font-bold border-b w-1/2">Cuplikan Soal</th><th className="p-3 font-bold text-center border-b">Kunci</th><th className="p-3 font-bold text-center border-b">Siswa</th><th className="p-3 font-bold text-center border-b">Hasil</th></tr></thead><tbody className="divide-y">{analyzingResult.analysis.map((item, idx) => (<tr key={idx} className={`hover:bg-gray-50 ${item.isCorrect ? 'bg-emerald-50/20' : 'bg-red-50/20'}`}><td className="p-3 text-center font-bold text-gray-500">{item.no}</td><td className="p-3 text-gray-600 text-xs">{item.questionSnippet}</td><td className="p-3 text-center font-bold text-emerald-600">{item.keyLabel}</td><td className={`p-3 text-center font-bold ${item.isCorrect ? 'text-emerald-600' : 'text-red-500'}`}>{item.userAnsLabel}</td><td className="p-3 text-center">{item.isCorrect ? <CheckCircle size={16} className="text-emerald-500 mx-auto"/> : <XCircle size={16} className="text-red-500 mx-auto"/>}</td></tr>))}</tbody></table>)}</div>
               
               {analyzingResult.cheatLogs && analyzingResult.cheatLogs.length > 0 && (
                   <div className="p-4 bg-red-50 border-t border-red-100">
                       <h4 className="font-bold text-red-800 flex items-center gap-2 mb-2 text-sm"><AlertTriangle size={16}/> Catatan Pelanggaran ({analyzingResult.cheatCount} Kali)</h4>
                       <ul className="list-disc list-inside text-xs text-red-600 ml-4 space-y-1">
                           {analyzingResult.cheatLogs.map((log, lidx) => <li key={lidx}>{log}</li>)}
                       </ul>
                   </div>
               )}

               <div className="p-4 border-t bg-gray-50 flex justify-end"><button onClick={() => setAnalyzingResult(null)} className="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-lg">Tutup</button></div></div></div>)}
               
               {/* MODAL DATA SISWA BELUM UJIAN DENGAN TOMBOL UNDUH */}
               {showPendingModal && (
                  <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in">
                      <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl border overflow-hidden flex flex-col max-h-[85vh]">
                          <div className="p-5 border-b flex justify-between items-center bg-gray-50">
                              <div>
                                  <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2"><Users size={20} className="text-orange-500"/> Data Belum Ujian</h3>
                                  <p className="text-xs text-gray-500 font-medium mt-1">
                                      {selectedScheduleObj ? `Jadwal: ${selectedScheduleObj.name}` : 'Pilih Jadwal Terlebih Dahulu'}
                                  </p>
                              </div>
                              <button onClick={() => setShowPendingModal(false)}><X size={20} className="text-gray-400 hover:text-red-500"/></button>
                          </div>
                          <div className="p-6 overflow-y-auto flex-1">
                              {filterSchedule === 'Semua Jadwal' ? (
                                  <div className="text-center py-8">
                                      <div className="w-16 h-16 bg-orange-50 text-orange-500 rounded-full flex items-center justify-center mx-auto mb-4"><AlertTriangle size={32} /></div>
                                      <p className="text-gray-600 font-bold">Pilih Jadwal Spesifik!</p>
                                      <p className="text-xs text-gray-400 mt-2">Ubah "Filter Mapel/Jadwal" di halaman sebelumnya untuk melihat absensi.</p>
                                  </div>
                              ) : pendingStudents.length === 0 ? (
                                  <div className="text-center py-8">
                                      <div className="w-16 h-16 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-4"><CheckCircle size={32} /></div>
                                      <h4 className="text-gray-800 font-bold text-lg mb-1">Luar Biasa!</h4>
                                      <p className="text-sm text-gray-500">Semua siswa {filterClass === 'Semua Kelas' ? 'yang ditugaskan' : `di kelas ${filterClass}`} telah menyelesaikan ujian ini.</p>
                                  </div>
                              ) : (
                                  <div>
                                      <div className="mb-4 flex justify-between items-center bg-orange-50 p-3 rounded-xl border border-orange-100">
                                          <span className="text-sm font-bold text-orange-800">Total Belum Mengerjakan:</span>
                                          <span className="bg-orange-500 text-white px-3 py-1 rounded-lg text-xs font-bold shadow-sm">{pendingStudents.length} Siswa</span>
                                      </div>
                                      <div className="border rounded-xl overflow-hidden shadow-sm">
                                          <table className="w-full text-sm text-left">
                                              <thead className="bg-gray-100 text-gray-600">
                                                  <tr>
                                                      <th className="p-3 font-bold border-b w-12 text-center text-xs">No</th>
                                                      <th className="p-3 font-bold border-b text-xs">Nama Lengkap Siswa</th>
                                                      <th className="p-3 font-bold border-b text-center text-xs w-24">Kelas</th>
                                                  </tr>
                                              </thead>
                                              <tbody className="divide-y divide-gray-100">
                                                  {pendingStudents.map((stud, idx) => (
                                                      <tr key={stud.username} className="hover:bg-orange-50/50 transition">
                                                          <td className="p-3 text-center text-gray-400 font-medium text-xs">{idx + 1}</td>
                                                          <td className="p-3 font-bold text-gray-700">{stud.name}</td>
                                                          <td className="p-3 text-center text-gray-500 text-xs font-bold">{stud.class}</td>
                                                      </tr>
                                                  ))}
                                              </tbody>
                                          </table>
                                      </div>
                                  </div>
                              )}
                          </div>
                          
                          {/* BAGIAN BAWAH MODAL (TOMBOL UNDUH DITAMBAHKAN DI SINI) */}
                          <div className="p-4 border-t bg-gray-50 flex justify-end gap-3">
                              <button onClick={() => setShowPendingModal(false)} className="px-6 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-xl font-bold text-sm shadow-sm hover:bg-gray-50 transition">
                                  Tutup
                              </button>
                              {filterSchedule !== 'Semua Jadwal' && pendingStudents.length > 0 && (
                                  <button onClick={handleDownloadPendingExcel} className="px-6 py-2.5 bg-emerald-600 text-white rounded-xl font-bold text-sm shadow-md hover:bg-emerald-700 transition flex items-center gap-2">
                                      <FileDown size={16} /> Unduh Excel
                                  </button>
                              )}
                          </div>
                      </div>
                  </div>
               )}

               {deleteResultTarget && (
                  <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in">
                      <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl border">
                          <div className="flex flex-col items-center text-center">
                              <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-600"><AlertTriangle size={32}/></div>
                              <h3 className="text-lg font-bold mb-2">Hapus Hasil Ujian?</h3>
                              <p className="text-sm text-gray-500 mb-6">Anda akan menghapus nilai <strong>{deleteResultTarget.studentName}</strong>. Setelah dihapus, siswa ini dapat <strong>mengerjakan ulang</strong> ujian tersebut.</p>
                              <div className="flex gap-3 w-full">
                                  <button onClick={() => setDeleteResultTarget(null)} className="flex-1 py-2 border rounded-xl font-bold text-sm hover:bg-gray-50 transition">Batal</button>
                                  <button onClick={confirmDeleteResult} className="flex-1 py-2 bg-red-600 text-white rounded-xl font-bold text-sm hover:bg-red-700 shadow-md transition flex justify-center items-center gap-2"><Trash2 size={16}/> Hapus & Reset</button>
                              </div>
                          </div>
                      </div>
                  </div>
               )}

               {showMassDeleteConfirm && (
                  <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in">
                      <div className="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl border">
                          <div className="flex flex-col items-center text-center">
                              <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-600"><AlertTriangle size={32}/></div>
                              <h3 className="text-lg font-bold mb-2 text-gray-900">Hapus Massal Data Ujian?</h3>
                              <p className="text-sm text-gray-600 mb-4">
                                  Anda akan menghapus <strong>{filteredResults.length}</strong> data nilai ujian untuk:
                              </p>
                              <div className="bg-gray-50 border border-gray-200 p-4 rounded-xl w-full mb-6 text-sm text-left">
                                  <p className="flex justify-between mb-2"><span className="text-gray-500">Kelas:</span> <span className="font-bold text-gray-800">{filterClass}</span></p>
                                  <p className="flex justify-between"><span className="text-gray-500">Jadwal/Mapel:</span> <span className="font-bold text-gray-800 truncate ml-4">{filterSchedule === 'Semua Jadwal' ? 'Semua Jadwal' : schedules.find(s => s.id == filterSchedule)?.name || 'Jadwal Spesifik'}</span></p>
                              </div>
                              <p className="text-xs text-red-500 mb-6 font-bold uppercase tracking-wider">Tindakan ini tidak dapat dibatalkan!</p>
                              <div className="flex gap-3 w-full">
                                  <button onClick={() => setShowMassDeleteConfirm(false)} className="flex-1 py-3 border rounded-xl font-bold text-sm hover:bg-gray-50 transition">Batal</button>
                                  <button onClick={handleMassDelete} className="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold text-sm hover:bg-red-700 shadow-md transition flex justify-center items-center gap-2"><Trash2 size={16}/> Ya, Hapus Semua</button>
                              </div>
                          </div>
                      </div>
                  </div>
               )}
            </div>
          )
        }

        function AdminKartuPeserta({ users, schoolProfile, notify }) {
            const [paperSize, setPaperSize] = useState('F4');
            const [selectedClass, setSelectedClass] = useState('Semua Kelas'); 
            const [isGenerating, setIsGenerating] = useState(false);
            
            const availableClasses = ['Semua Kelas', ...new Set(users.filter(u => u.role === 'student').map(u => u.class))].sort();
            const students = users.filter(u => u.role === 'student' && (selectedClass === 'Semua Kelas' || u.class === selectedClass));
            
            const handleDownloadPDF = () => {
                if (!window.html2pdf) {
                    setIsGenerating(true);
                    const script = document.createElement('script'); script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js";
                    script.onload = () => { handleDownloadPDF(); }; document.body.appendChild(script); return;
                }
                
                if (students.length === 0) return notify("Tidak ada data siswa untuk kelas ini.", "error");

                setIsGenerating(true);
                
                const pages = document.querySelectorAll('.kartu-page-container');
                pages.forEach(p => p.style.marginBottom = '0px');

                setTimeout(() => {
                    const element = document.getElementById('printable-area'); 
                    const pdfFormat = paperSize === 'F4' ? [215, 330] : 'a4';
                    
                    const opt = { 
                        margin: 0, 
                        filename: `KARTU_${selectedClass.replace(/\s+/g, '_')}.pdf`, 
                        image: { type: 'jpeg', quality: 0.98 }, 
                        html2canvas: { scale: 1.5, useCORS: true, scrollY: 0 }, 
                        jsPDF: { unit: 'mm', format: pdfFormat, orientation: 'portrait' },
                        pagebreak: { mode: ['legacy'] } 
                    };
                    
                    window.html2pdf().set(opt).from(element).save().then(() => { 
                        setIsGenerating(false); 
                        pages.forEach(p => p.style.marginBottom = '2rem');
                        notify("Kartu peserta berhasil diunduh."); 
                    }).catch(err => {
                        console.error(err);
                        setIsGenerating(false);
                        pages.forEach(p => p.style.marginBottom = '2rem');
                        notify("Memori penuh! Coba unduh per kelas saja.", "error");
                    });
                }, 500);
            };
            
            const chunks = [];
            for (let i = 0; i < students.length; i += 8) { chunks.push(students.slice(i, i + 8)); }
            
            return (
                <div className="space-y-6 animate-fade-in">
                    <div className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border print:hidden gap-4">
                        <div><h3 className="font-bold text-lg text-gray-800">Cetak Kartu Peserta</h3></div>
                        <div className="flex items-center gap-3 flex-wrap justify-end">
                            <select value={selectedClass} onChange={(e) => setSelectedClass(e.target.value)} className="bg-gray-50 border p-2.5 rounded-xl text-sm font-bold"><option>Semua Kelas</option>{availableClasses.slice(1).map(c=><option key={c}>{c}</option>)}</select>
                            <select value={paperSize} onChange={(e) => setPaperSize(e.target.value)} className="bg-gray-50 border p-2.5 rounded-xl text-sm font-bold"><option value="A4">A4</option><option value="F4">F4</option></select>
                            <button onClick={handleDownloadPDF} disabled={isGenerating} className="bg-indigo-600 text-white px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:bg-indigo-700 transition">
                                {isGenerating ? <Loader className="animate-spin" size={18}/> : <FileDown size={18}/>} Unduh PDF
                            </button>
                        </div>
                    </div>
                    
                    <div className="bg-gray-200 p-6 rounded-2xl border flex flex-col items-center w-full overflow-x-auto">
                        <div id="printable-area" className="min-w-fit bg-white">
                            {chunks.map((chunk, pageIndex) => (
                                <div key={pageIndex}>
                                    <div className="kartu-page-container mx-auto shadow-sm relative bg-white" 
                                         style={{ 
                                             width: paperSize === 'F4' ? '215mm' : '210mm', 
                                             height: paperSize === 'F4' ? '329mm' : '296mm', 
                                             padding: '10mm', 
                                             display: 'grid', 
                                             gridTemplateColumns: 'repeat(2, 1fr)', 
                                             gridTemplateRows: 'repeat(4, 1fr)', 
                                             gap: '10mm', 
                                             boxSizing: 'border-box',
                                             marginBottom: '2rem'
                                         }}>
                                         {chunk.map(s => (
                                             <div key={s.username} className="border border-black p-4 relative flex flex-col h-full bg-white text-black text-[10px] overflow-hidden">
                                                 <div className="flex items-center gap-2 pb-1 border-b-[2px] border-black mb-2">
                                                     <div className="w-10 h-10 flex items-center justify-center shrink-0">{schoolProfile.logoUrl ? <img src={schoolProfile.logoUrl} className="max-w-full max-h-full object-contain"/> : <Shield size={30} />}</div>
                                                     <div className="flex-1 leading-tight text-center">
                                                         <h3 className="font-black text-[11px] uppercase tracking-tighter">{schoolProfile.examName}</h3>
                                                         <p className="font-bold text-[10px] uppercase text-indigo-800">{schoolProfile.schoolName}</p>
                                                         <p className="text-[7px] italic opacity-80 leading-none mt-0.5 line-clamp-2">{schoolProfile.address}</p>
                                                     </div>
                                                 </div>
                                                 <div className="flex gap-3 flex-1">
                                                     <div className="w-20 h-[85px] border border-black flex items-center justify-center text-center text-[8px] font-bold shrink-0 bg-gray-50">PAS FOTO<br/>3 x 4</div>
                                                     <div className="flex-1 flex flex-col justify-between">
                                                         <div className="grid grid-cols-[45px_5px_1fr] gap-x-1 gap-y-1 font-bold text-[9px]">
                                                             <span>NIS</span><span>:</span><span>{s.nis}</span>
                                                             <span>Nama</span><span>:</span><span className="truncate">{s.name}</span>
                                                             <span>Kelas</span><span>:</span><span>{s.class}</span>
                                                             <span>Sandi</span><span>:</span><span className="text-indigo-600 font-mono tracking-widest">{s.password}</span>
                                                         </div>
                                                         <div className="text-right mt-1">
                                                             <p className="text-[7px]">Kepala Sekolah,</p>
                                                             <div className="h-10"></div>
                                                             <p className="text-[8px] font-bold underline leading-none mb-1">{schoolProfile.headmaster}</p>
                                                             <p className="text-[7px] leading-none">NIP. {schoolProfile.nip}</p>
                                                         </div>
                                                     </div>
                                                 </div>
                                                 <div className="absolute bottom-1 left-2 opacity-5 pointer-events-none -rotate-12"><Shield size={40} /></div>
                                             </div>
                                         ))}
                                    </div>
                                    {pageIndex < chunks.length - 1 && <div className="html2pdf__page-break"></div>}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            )
        }

        function AdminDashboardLayout({ user, setCurrentUser, onLogout, questionBanks, setQuestionBanks, users, setUsers, results, setResults, schedules, setSchedules, schoolProfile, setSchoolProfile, onFactoryReset, onGenerateSimulation, notify }) {
          const [activeMenu, setActiveMenu] = useState('dashboard');
          const [isSidebarOpen, setIsSidebarOpen] = useState(false);
          const [showProfileModal, setShowProfileModal] = useState(false);
          const [profileForm, setProfileForm] = useState({ name: '', username: '', password: '' });
          
          useEffect(() => { 
              if (user) setProfileForm({ name: user.name, username: user.username, password: user.password }); 
              const savedAdminMenu = secureStorage.getItem('siujang_admin_menu');
              if (savedAdminMenu) setActiveMenu(savedAdminMenu);
          }, [user]);

          useEffect(() => {
              secureStorage.setItem('siujang_admin_menu', activeMenu);
          }, [activeMenu]);

          const handleUpdateProfile = (e) => { e.preventDefault(); if (!profileForm.name || !profileForm.username || !profileForm.password) { notify("Semua kolom harus diisi!", "error"); return; } const updatedUsers = users.map(u => u.username === user.username ? { ...u, ...profileForm } : u); setUsers(updatedUsers); setCurrentUser({ ...user, ...profileForm }); setShowProfileModal(false); notify("Profil berhasil diperbarui!"); };
          const renderContent = () => {
            switch(activeMenu) {
              case 'dashboard': return <AdminSummary users={users} questionBanks={questionBanks} schedules={schedules} onGenerate={onGenerateSimulation} onFactoryReset={onFactoryReset} notify={notify} />;
              case 'peserta': return <AdminParticipantData users={users} setUsers={setUsers} notify={notify} />;
              case 'profil_sekolah': return <AdminSchoolProfile profile={schoolProfile} setProfile={setSchoolProfile} notify={notify} />;
              case 'bank_soal': return <AdminBankSoal questionBanks={questionBanks} setQuestionBanks={setQuestionBanks} notify={notify} />;
              case 'jadwal': return <AdminJadwalUjian schedules={schedules} setSchedules={setSchedules} users={users} questionBanks={questionBanks} notify={notify} />;
              case 'hasil': return <AdminResults results={results} setResults={setResults} schedules={schedules} questionBanks={questionBanks} users={users} notify={notify} />;
              case 'kartu': return <AdminKartuPeserta users={users} schoolProfile={schoolProfile} notify={notify} />;
              default: return null;
            }
          };
          return (
            <div className="flex h-screen bg-gray-100 overflow-hidden print:h-auto print:overflow-visible">
              {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden backdrop-blur-sm transition-opacity" onClick={() => setIsSidebarOpen(false)} />}
              <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-[#0f172a] text-white transform transition-transform md:relative md:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} print:hidden shadow-2xl md:shadow-none`}>
                <div className="h-16 flex items-center gap-3 px-6 bg-[#1e293b] border-b border-gray-700"><Shield size={20} className="text-indigo-400" /> <span className="font-bold">Administrator</span></div>
                <nav className="p-4 space-y-1 overflow-y-auto h-[calc(100vh-4rem)]">
                  <SidebarItem icon={<LayoutDashboard size={18}/>} label="Dashboard" active={activeMenu === 'dashboard'} onClick={() => { setActiveMenu('dashboard'); setIsSidebarOpen(false); }} />
                  <SidebarItem icon={<School size={18}/>} label="Profil Sekolah" active={activeMenu === 'profil_sekolah'} onClick={() => { setActiveMenu('profil_sekolah'); setIsSidebarOpen(false); }} />
                  <SidebarItem icon={<Users size={18}/>} label="Data Peserta" active={activeMenu === 'peserta'} onClick={() => { setActiveMenu('peserta'); setIsSidebarOpen(false); }} />
                  <SidebarItem icon={<BookOpen size={18}/>} label="Bank Soal" active={activeMenu === 'bank_soal'} onClick={() => { setActiveMenu('bank_soal'); setIsSidebarOpen(false); }} />
                  <SidebarItem icon={<Calendar size={18}/>} label="Jadwal Ujian" active={activeMenu === 'jadwal'} onClick={() => { setActiveMenu('jadwal'); setIsSidebarOpen(false); }} />
                  <SidebarItem icon={<CheckCircle size={18}/>} label="Hasil Ujian" active={activeMenu === 'hasil'} onClick={() => { setActiveMenu('hasil'); setIsSidebarOpen(false); }} />
                  <SidebarItem icon={<CreditCard size={18}/>} label="Cetak Kartu" active={activeMenu === 'kartu'} onClick={() => { setActiveMenu('kartu'); setIsSidebarOpen(false); }} />
                  <button onClick={onLogout} className="w-full flex items-center gap-3 px-4 py-3 text-red-400 hover:bg-red-900/20 rounded-lg mt-8 text-sm"><LogOut size={18}/> Keluar</button>
                </nav>
              </aside>
              <div className="flex-1 flex flex-col h-screen overflow-hidden print:h-auto print:overflow-visible print:block">
                  <header className="h-16 bg-white shadow-sm flex items-center justify-between px-6 print:hidden">
                  <button onClick={() => setIsSidebarOpen(true)} className="md:hidden p-2 -ml-2 text-gray-600"><Menu /></button>
                  <div className="font-bold text-gray-800">Si Ujang PRO</div>
                  <div className="flex items-center gap-4">
                      <div className="text-right hidden md:block"><p className="text-sm font-bold text-gray-700">{user?.name}</p><p className="text-xs text-gray-500 capitalize">{user?.role}</p></div>
                      <div className="relative group cursor-pointer" onClick={() => setShowProfileModal(true)} title="Klik untuk Edit Profil"><div className="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-700 font-bold uppercase border-2 border-indigo-50 hover:bg-indigo-200 transition shadow-sm">{user?.name?.charAt(0)}</div><div className="absolute -bottom-1 -right-1 bg-white rounded-full p-1 border border-gray-100 shadow-sm text-gray-400 group-hover:text-indigo-600"><UserCog size={12} /></div></div>
                  </div>
                </header>
                <main className="flex-1 overflow-y-auto p-4 md:p-8 print:p-0 print:overflow-visible print:h-auto">{renderContent()}</main>
                {showProfileModal && (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in"><div className="bg-white rounded-2xl w-full max-w-sm shadow-2xl border overflow-hidden"><div className="p-6 border-b flex justify-between items-center bg-gray-50"><h3 className="font-bold text-lg flex items-center gap-2"><UserCog size={20}/> Edit Profil Admin</h3><button onClick={() => setShowProfileModal(false)}><X size={20} className="text-gray-400 hover:text-red-500"/></button></div><form onSubmit={handleUpdateProfile} className="p-6 space-y-4"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Nama Lengkap</label><input className="w-full p-3 border rounded-xl" value={profileForm.name} onChange={e => setProfileForm({...profileForm, name: e.target.value})} required /></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Username</label><input className="w-full p-3 border rounded-xl" value={profileForm.username} onChange={e => setProfileForm({...profileForm, username: e.target.value})} required /></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Password Baru</label><div className="relative"><input type="text" className="w-full p-3 border rounded-xl pr-10" value={profileForm.password} onChange={e => setProfileForm({...profileForm, password: e.target.value})} required /><Lock size={16} className="absolute right-3 top-3.5 text-gray-400" /></div></div><button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition">Simpan Perubahan</button></form></div></div>
                )}
              </div>
            </div>
          );
        }

        function App() {
          const [view, setView] = useState('auth');
          const [showLogoutModal, setShowLogoutModal] = useState(false); const [notification, setNotification] = useState(null);
          const [currentUser, setCurrentUser] = useState(null); 
          const [activeExamQuestions, setActiveExamQuestions] = useState([]);
          const [activeScheduleId, setActiveScheduleId] = useState(null);
          const [isFirebaseLoaded, setIsFirebaseLoaded] = useState(false);
          
          const isStudentSession = view.startsWith('student');
          const isAdminSession = view === 'admin';
          
          useGlobalSecurity({ 
              protectDevTools: true,       
              protectCopyPaste: !isAdminSession, 
              protectContextMenu: true,    
              protectFocus: isStudentSession 
          });

          useEffect(() => {
              if (isAdminSession) { document.body.classList.add('admin-mode'); } 
              else { document.body.classList.remove('admin-mode'); }
          }, [isAdminSession]);

          // --- FITUR AUTO-LOGIN (SESSION PERSISTENCE) ---
          useEffect(() => {
              const savedUser = secureStorage.getItem('siujang_session_user', null);
              const savedView = secureStorage.getItem('siujang_session_view', 'auth');
              const savedScheduleId = secureStorage.getItem('siujang_session_schedule', null);
              
              if (savedUser) { 
                  setCurrentUser(savedUser); 
                  setView(savedView); 
                  if (savedScheduleId) setActiveScheduleId(savedScheduleId); 
              }
          }, []);

          useEffect(() => {
              if (currentUser) {
                  secureStorage.setItem('siujang_session_user', currentUser);
                  secureStorage.setItem('siujang_session_view', view);
                  if (activeScheduleId) {
                      secureStorage.setItem('siujang_session_schedule', activeScheduleId);
                  } else {
                      secureStorage.removeItem('siujang_session_schedule');
                  }
              } else {
                  secureStorage.removeItem('siujang_session_user');
                  secureStorage.removeItem('siujang_session_view');
                  secureStorage.removeItem('siujang_session_schedule');
              }
          }, [currentUser, view, activeScheduleId]);

          const [questionBanks, setQuestionBanks] = useState(() => loadData('siujang_banks', INITIAL_BANKS));
          const [users, setUsers] = useState(() => loadData('siujang_users', INITIAL_USERS));
          const [examResults, setExamResults] = useState(() => loadData('siujang_results', []));
          const [schoolProfile, setSchoolProfile] = useState(() => loadData('siujang_profile', INITIAL_SCHOOL_PROFILE));
          const [schedules, setSchedules] = useState(() => loadData('siujang_schedules', []));
          const [pendingResults, setPendingResults] = useState(() => loadData('siujang_pending_uploads', []));
          
          const activeSchedule = schedules.find(s => s.id === activeScheduleId);

          const [isSaving, setIsSaving] = useState(false);
          const isOnline = useNetworkStatus();
          const isRemoteUpdate = useRef(false);
          
          // MESIN SISWA
          useEffect(() => {
              if (!auth || !db) return;
              const init = async () => { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } };
              init();
              
              const unsubscribeAuth = onAuthStateChanged(auth, async (user) => {
                  if (user) {
                      try {
                          const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'exam_system', 'master');
                          const snapshot = await getDoc(docRef);
                          if (snapshot.exists()) {
                              const data = snapshot.data(); isRemoteUpdate.current = true;
                              if (data.users) setUsers(typeof data.users === 'string' ? JSON.parse(data.users) : data.users);
                              if (data.schedules) setSchedules(typeof data.schedules === 'string' ? JSON.parse(data.schedules) : data.schedules);
                              if (data.profile) setSchoolProfile(data.profile);
                          }

                          const bankSnap = await getDocs(collection(db, 'siujang_banks'));
                          const banks = [];
                          bankSnap.forEach(d => banks.push(d.data()));
                          if (banks.length > 0) setQuestionBanks(banks);

                          const resultSnap = await getDocs(collection(db, 'siujang_results'));
                          const resultsData = [];
                          resultSnap.forEach(d => resultsData.push({ ...d.data(), docId: d.id }));
                          if (resultsData.length > 0) setExamResults(resultsData);

                          setTimeout(() => { isRemoteUpdate.current = false; }, 500);
                      } catch (err) { console.error("Error fetching data:", err); }
                  }
              }); 
              return () => unsubscribeAuth();
          }, []);

          // MESIN ADMIN
          useEffect(() => {
              if (view === 'admin' && db) {
                  const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'exam_system', 'master');
                  const unsubMaster = onSnapshot(docRef, (snapshot) => {
                      if (snapshot.exists()) {
                          const data = snapshot.data(); isRemoteUpdate.current = true;
                          if (data.users) setUsers(typeof data.users === 'string' ? JSON.parse(data.users) : data.users);
                          if (data.schedules) setSchedules(typeof data.schedules === 'string' ? JSON.parse(data.schedules) : data.schedules);
                          if (data.profile) setSchoolProfile(data.profile);
                          setTimeout(() => { isRemoteUpdate.current = false; setIsFirebaseLoaded(true); }, 500);
                      } else {
                          setIsFirebaseLoaded(true);
                      }
                  });

                  const unsubResults = onSnapshot(collection(db, 'siujang_results'), (snapshot) => {
                      const resultsData = [];
                      snapshot.forEach((doc) => resultsData.push({ ...doc.data(), docId: doc.id }));
                      setExamResults(resultsData);
                  });

                  const fetchBanks = async () => {
                      try {
                          const bankSnap = await getDocs(collection(db, 'siujang_banks'));
                          const banks = [];
                          bankSnap.forEach(d => banks.push(d.data()));
                          if (banks.length > 0) setQuestionBanks(banks);
                      } catch (e) { console.error("Gagal muat bank soal", e); }
                  };
                  fetchBanks();

                  return () => { unsubMaster(); unsubResults(); }; 
              }
          }, [view]);
          
          // RECOVERY LOGIC
          useEffect(() => {
            if (view === 'student_exam' && activeScheduleId) {
                if (activeExamQuestions.length === 0) {
                    const schedule = schedules.find(s => s.id === activeScheduleId);
                    if (schedule) {
                        const cacheKey = `siujang_qs_${schedule.id}`;
                        const cachedQuestions = secureStorage.getItem(cacheKey);

                        if (cachedQuestions && cachedQuestions.length > 0) {
                            setActiveExamQuestions(cachedQuestions);
                        } else if (questionBanks.length > 0) {
                            const bank = questionBanks.find(b => b.id === schedule.bankId);
                            if (bank) {
                                let finalQuestions = JSON.parse(JSON.stringify(bank.questions));
                                if (schedule.randomizeQuestions) finalQuestions = shuffleArray(finalQuestions);
                                if (schedule.randomizeOptions) finalQuestions = finalQuestions.map(shuffleOptionsInQuestion);
                                setActiveExamQuestions(finalQuestions);
                            }
                        }
                    } else {
                        setView('student_dashboard');
                    }
                }
            }
          }, [view, activeScheduleId, questionBanks, schedules, activeExamQuestions.length]);

          useEffect(() => {
             if (!auth?.currentUser || !db) return; 
             if (isRemoteUpdate.current) return; 
             if (!isOnline) return; 
             if (view !== 'admin') return; 
             if (!isFirebaseLoaded) return; // GEMBOK PENGAMAN

             const saveData = async () => { 
                 setIsSaving(true); 
                 try { 
                     const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'exam_system', 'master'); 
                     await updateDoc(docRef, { 
                         users, 
                         schedules, 
                         profile: schoolProfile 
                     }); 
                 } catch(e) { 
                     console.error("Gagal simpan cloud:", e); setNotification({ message: "Gagal simpan ke cloud!", type: "error" }); 
                 } finally { 
                     setTimeout(() => setIsSaving(false), 800); 
                 } 
             }
             const timeout = setTimeout(saveData, 500); return () => clearTimeout(timeout);
          }, [users, schedules, schoolProfile, isOnline, view, isFirebaseLoaded]); 

          useEffect(() => { localStorage.setItem('siujang_pending_uploads', JSON.stringify(pendingResults)); }, [pendingResults]);
          const notify = (message, type = 'success') => { setNotification({ message, type }); };
          const handleLogin = (user) => { setCurrentUser(user); setView(user.role === 'admin' ? 'admin' : 'student_dashboard'); };
          
          const confirmLogout = () => { 
              if (view === 'student_exam' && currentUser && activeScheduleId) {
                  const resumeKey = `siujang_progress_id_${currentUser.username}`;
                  const storageKey = `siujang_progress_${activeScheduleId}_${currentUser.username}`;
                  const saved = secureStorage.getItem(storageKey);
                  
                  if (activeExamQuestions.length > 0 && saved && saved.ans) {
                      let s = 0;
                      activeExamQuestions.forEach(q => { 
                          const userAns = saved.ans[q.id];
                          const correct = q.correctAnswer;
                          if (!userAns) return; 
                          let isCorrect = false;
                          if (q.type === 'truefalse') { 
                              isCorrect = JSON.stringify(userAns) === JSON.stringify(correct);
                          } else { 
                              const sortedUser = [...userAns].sort();
                              const sortedCorrect = [...correct].sort();
                              isCorrect = JSON.stringify(sortedUser) === JSON.stringify(sortedCorrect);
                          }
                          if (isCorrect) s += 1;
                      });
                      const finalScore = Math.round((s / activeExamQuestions.length) * 100);
                      const newResult = { 
                          studentName: currentUser.name, 
                          score: finalScore, 
                          cheatCount: saved.cheatCount || 0,
                          cheatLogs: saved.cheatLogs || [],
                          answers: saved.ans,
                          scheduleId: activeScheduleId,
                          scheduleName: activeSchedule?.name || '-',
                          bankName: activeSchedule?.bankName || '-',
                          date: new Date().toLocaleString()
                      };
                      
                      if (!isOnline) { 
                          setPendingResults(prev => [...prev, newResult]); 
                      } else { 
                          setExamResults(prev => [ ...prev, newResult ]); 
                          try {
                              const resultsCollection = collection(db, 'siujang_results');
                              addDoc(resultsCollection, newResult);
                          } catch(e) {}
                      }
                      
                      secureStorage.removeItem(resumeKey);
                      secureStorage.removeItem(storageKey);
                  }
                  
                  if (document.fullscreenElement && document.exitFullscreen) {
                      document.exitFullscreen().catch(e => console.log(e));
                  }
              }

              setCurrentUser(null); 
              setView('auth'); 
              setShowLogoutModal(false); 
              setActiveScheduleId(null);
              setActiveExamQuestions([]);
          };
          
          const handleStartExam = (scheduleId) => { 
              const alreadyTaken = examResults.some(r => r.studentName === currentUser.name && r.scheduleId === scheduleId) ||
                                   pendingResults.some(r => r.studentName === currentUser.name && r.scheduleId === scheduleId);
              if (alreadyTaken) { notify("Ujian sudah dikerjakan! (Cek Riwayat)", "error"); return; }
              
              const schedule = schedules.find(s => s.id === scheduleId);
              if (schedule) { 
                  const bank = questionBanks.find(b => b.id === schedule.bankId); 
                  if (bank) { 
                      let finalQuestions = JSON.parse(JSON.stringify(bank.questions));
                      if (schedule.randomizeQuestions) {
                          finalQuestions = shuffleArray(finalQuestions);
                      }
                      if (schedule.randomizeOptions) {
                          finalQuestions = finalQuestions.map(q => shuffleOptionsInQuestion(q));
                      }
                      setActiveExamQuestions(finalQuestions); 
                      setActiveScheduleId(scheduleId); 
                      setView('student_exam'); 
                  } else { 
                      notify("Paket soal tidak ditemukan!", "error"); 
                  } 
              }
          };

          const handleExamSubmit = async (result) => { 
              // CEGAT NILAI GANDA DI SINI
              const isDuplicate = examResults.some(r => r.studentName === currentUser.name && r.scheduleId === activeScheduleId) ||
                                  pendingResults.some(r => r.studentName === currentUser.name && r.scheduleId === activeScheduleId);
              if (isDuplicate) {
                  setView('student_dashboard'); setActiveScheduleId(null);
                  return; 
              }

              const newResult = { 
                  ...result, 
                  scheduleId: activeScheduleId, 
                  scheduleName: activeSchedule?.name || '-',
                  bankName: activeSchedule?.bankName || '-',
                  date: new Date().toLocaleString() 
              };
              
              setView('result'); setActiveScheduleId(null); 
              setExamResults(prev => [...prev, newResult]);

              if (!isOnline) { 
                  setPendingResults(prev => [...prev, newResult]); 
                  notify("Anda sedang OFFLINE. Jawaban masuk antrian.", "warning"); 
              } else { 
                  try {
                      // Simpan ke koleksi baru yang terpisah
                      const resultsCollection = collection(db, 'siujang_results');
                      const docRef = await addDoc(resultsCollection, newResult);
                      setExamResults(prev => prev.map(r => r === newResult ? { ...r, docId: docRef.id } : r));
                  } catch (e) {
                      setPendingResults(prev => [...prev, newResult]);
                      notify("Server sibuk. Masuk antrian upload.", "error");
                  }
              }
          };

          const handleSyncPending = async () => {
              if (!isOnline) { notify("Masih Offline! Cari sinyal dulu.", "warning"); return; }
              if (pendingResults.length === 0) return;
              const myPending = pendingResults.filter(r => r.studentName === currentUser.name);
              if (myPending.length > 0) { 
                  setExamResults(prev => [...prev, ...myPending]); 
                  setPendingResults(prev => prev.filter(r => r.studentName !== currentUser.name)); 
                  
                  try {
                      const resultsCollection = collection(db, 'siujang_results');
                      const uploadPromises = myPending.map(r => addDoc(resultsCollection, r));
                      await Promise.all(uploadPromises);
                      notify("Sukses upload semua hasil tertunda!", "success");
                  } catch(e) { 
                      notify("Gagal sync ke server", "error"); 
                  }
              }
          };

          const handleFactoryReset = async () => { 
              setUsers(INITIAL_USERS); setQuestionBanks(INITIAL_BANKS); setSchedules([]); setExamResults([]); setSchoolProfile(INITIAL_SCHOOL_PROFILE); localStorage.clear(); 
              try {
                  const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'exam_system', 'master');
                  await setDoc(docRef, { users: INITIAL_USERS, schedules: [], profile: INITIAL_SCHOOL_PROFILE });
              } catch(e) {}
              notify("Sistem berhasil di-reset sepenuhnya.", "success"); 
          };
          
          const handleGenerateSimulation = (config) => { 
              return new Promise((resolve) => { 
                  setTimeout(() => { 
                      const timestamp = Date.now(); 
                      const { count, prefixName, subjectName } = config; 
                      const simulatedStudents = Array.from({ length: parseInt(count) }, (_, i) => ({ username: (202400 + i + 1).toString(), password: "123", role: "student", name: `${prefixName} ${i + 1}`, nis: (202400 + i + 1).toString(), class: "X-SIM" })); 
                      const simQuestions = [ 
                          { id: timestamp + 1, type: 'single', question: "<p><strong>[PG]</strong> Ibukota negara Indonesia adalah?</p>", options: ["Jakarta", "Bandung", "Surabaya", "Medan", "Makassar"], correctAnswer: [0], questionImages: [], optionImages: [[], [], [], [], []] }, 
                          { id: timestamp + 2, type: 'complex', question: "<p><strong>[PGM]</strong> Pilihlah pernyataan yang benar di bawah ini!</p>", options: ["Kucing berkembang biak dengan bertelur.", "Paus adalah hewan mamalia air.", "Kelelawar adalah burung.", "Ular adalah hewan reptil.", "Lumba-lumba bernapas menggunakan insang."], correctAnswer: [1, 3], questionImages: [], optionImages: [[], [], [], [], []] }, 
                          { id: timestamp + 3, type: 'truefalse', question: "<p><strong>[B/S]</strong> Tentukan kebenaran pernyataan berikut:</p>", options: ["Matahari terbit dari timur.", "Air membeku pada suhu 100 derajat celcius.", "Bumi mengelilingi bulan.", "Manusia bernapas membutuhkan oksigen.", "Es batu mencair saat dipanaskan."], correctAnswer: ["B", "S", "S", "B", "B"], questionImages: [], optionImages: [[], [], [], [], []] } 
                      ];
                      const newBank = { id: 'bank_sim_' + timestamp, code: 'SIM-' + Math.floor(Math.random() * 1000), subject: subjectName, date: new Date().toLocaleDateString('id-ID'), questions: simQuestions };
                      const newSchedule = { id: timestamp + 100, name: `Ujian ${subjectName}`, bankId: newBank.id, bankName: newBank.subject, date: new Date().toISOString().split('T')[0], time: "08:00", duration: 60, token: "UJI" + Math.floor(Math.random() * 99), classes: ["X-SIM"], randomizeQuestions: true, randomizeOptions: false };
                      setUsers(prev => { const cleanUsers = prev.filter(u => !u.username.startsWith('20240')); return [...cleanUsers, ...simulatedStudents]; }); 
                      setQuestionBanks(prev => [...prev, newBank]); 
                      setSchedules(prev => [...prev, newSchedule]); 
                      
                      if (db) {
                          setDoc(doc(db, 'siujang_banks', newBank.id), newBank).catch(e=>console.error(e));
                      }
                      resolve(true); 
                  }, 1500); 
              }); 
          };
          
          return (
            <div className="min-h-screen bg-gray-50 font-sans text-gray-800 select-none flex flex-col">
              {notification && <Toast message={notification.message} type={notification.type} onClose={() => setNotification(null)} />}
              <div className="fixed bottom-4 left-4 z-[200] bg-white/90 backdrop-blur-sm border border-gray-200 px-5 py-2.5 rounded-full shadow-xl text-xs font-bold flex items-center gap-3 transition-all pointer-events-none">
                 {!isOnline ? (<> <CloudOff size={16} className="text-red-500 animate-pulse"/> <span className="text-red-600">Mode Offline (Data Lokal)</span> </>) : isSaving ? (<> <Loader size={16} className="animate-spin text-indigo-500"/> <span className="text-indigo-600">Menyinkronkan ke Cloud...</span> </>) : (<> <Cloud size={16} className="text-emerald-500"/> <span className="text-emerald-700">Data Tersimpan & Aman</span> </>)}
              </div>
              {view !== 'admin' && (<nav className="bg-indigo-600 text-white p-4 shadow-md sticky top-0 z-50"><div className="max-w-6xl mx-auto flex justify-between items-center"><div className="flex items-center gap-3">{schoolProfile.logoUrl ? <img src={schoolProfile.logoUrl} className="w-8 h-8 object-contain bg-white rounded-full p-0.5" onError={(e) => { e.target.style.display = 'none'; }} /> : <Shield className="w-6 h-6" />}<div className="flex flex-col"><span className="font-bold text-lg leading-tight">{schoolProfile.examName}</span><span className="text-[10px] opacity-80 uppercase tracking-wider">{schoolProfile.schoolName}</span></div></div>{currentUser && (<div className="flex items-center gap-2"><div className="flex items-center gap-2 text-xs bg-indigo-700 px-3 py-1.5 rounded-full border border-indigo-500"><User size={14} /> <span>{currentUser.name}</span></div><button onClick={() => setShowLogoutModal(true)} className="bg-indigo-700 hover:bg-indigo-800 p-2 rounded-lg transition-colors"><LogOut size={18} /></button></div>)}</div></nav>)}
              <main className={`flex-grow w-full ${view !== 'admin' ? 'max-w-6xl mx-auto p-4' : ''}`}>{view === 'auth' && <AuthScreen onLogin={handleLogin} users={users} schoolProfile={schoolProfile} notify={notify} />}{view === 'admin' && (<AdminDashboardLayout user={currentUser} setCurrentUser={setCurrentUser} onLogout={() => setShowLogoutModal(true)} questionBanks={questionBanks} setQuestionBanks={setQuestionBanks} users={users} setUsers={setUsers} results={examResults} setResults={setExamResults} schedules={schedules} setSchedules={setSchedules} schoolProfile={schoolProfile} setSchoolProfile={setSchoolProfile} onFactoryReset={handleFactoryReset} onGenerateSimulation={handleGenerateSimulation} notify={notify} />)}{view === 'student_dashboard' && <StudentDashboard user={currentUser} schedules={schedules} results={examResults} onStartExam={handleStartExam} pendingResults={pendingResults} onSyncPending={handleSyncPending} notify={notify} />}{view === 'student_exam' && <ExamPortal user={currentUser} questions={activeExamQuestions} onSubmit={handleExamSubmit} notify={notify} schoolProfile={schoolProfile} examInfo={activeSchedule} />}{view === 'result' && <ResultScreen setView={setView} />}</main>
              
              {showLogoutModal && (
                  <div className="fixed inset-0 z-[99999] flex items-center justify-center bg-black/50 p-4 backdrop-blur-sm animate-fade-in">
                      <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl border text-center">
                          <LogOut className="w-16 h-16 text-red-600 mx-auto mb-4" />
                          <h3 className="text-xl font-bold mb-2">Keluar Aplikasi?</h3>
                          {view === 'student_exam' ? (
                              <p className="text-orange-600 text-sm mb-6 font-bold">Peringatan: Anda sedang dalam ujian! Jika keluar sekarang, ujian akan dihentikan dan dinilai secara otomatis!</p>
                          ) : (
                              <p className="text-gray-500 text-sm mb-6">Sesi Anda akan diakhiri.</p>
                          )}
                          <div className="flex gap-3 w-full">
                              <button onClick={() => setShowLogoutModal(false)} className="flex-1 py-2.5 border rounded-xl font-bold hover:bg-gray-50 transition">Batal</button>
                              <button onClick={confirmLogout} className="flex-1 py-2.5 bg-red-600 text-white rounded-xl font-bold shadow-md hover:bg-red-700 transition">Ya, Keluar</button>
                          </div>
                      </div>
                  </div>
              )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
